# Sprint SPR-009 — Cost Tracking & Debug Session Panel

Implement comprehensive cost tracking for STT/LLM/TTS interactions with per-interaction and session-level aggregation, plus a new SESSION debug tab showing costs, duration, and interaction count in coach-min.

## Meta
- Sprint ID: SPR-009
- Status: planned
- Start date: 2025-01-01
- End date: 2025-01-15
- Links: [Overview](./overview.md) · [PRD](../../planning/prd2.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Add cost fields to interactions and sessions tables with per-service breakdown (STT/LLM/TTS)
- [ ] Implement cost calculation service with provider-specific pricing models
- [ ] Extend STT, TTS, and Chat APIs to calculate and store costs
- [ ] Add SESSION tab to coach-min debug panel and coach-debug with real-time cost tracking
- [ ] Create session cost aggregation API endpoint

## Planned Tasks
- [x] Database Schema Extensions — <owner> (1d)
  - [x] Add cost fields to interactions table: sttCostCents, llmCostCents, ttsCostCents, totalCostCents
  - [x] Add usage fields: sttDurationMs, llmTokensIn, llmTokensOut, ttsCharacters
  - [x] Add session cost aggregation fields to sessions table
  - [x] Add session metrics: interactionCount, durationMs, startTime, endTime
- [x] Cost Calculation Service — <owner> (1d)
  - [x] Create /lib/cost-calculator.ts with provider-specific pricing
  - [x] Support OpenAI, Google, Deepgram pricing models
  - [x] Handle per-token, per-minute, per-character pricing
  - [x] Add cost validation and error handling
- [x] API Endpoint Updates — <owner> (2d)
  - [x] Extend STT endpoint to calculate and store audio duration costs
  - [x] Extend TTS endpoint to calculate and store character-based costs
  - [ ] Extend Chat SSE to extract token usage and calculate LLM costs
  - [ ] Create GET /api/v1/sessions/costs for session cost aggregation
- [ ] Debug Panel UI — <owner> (2d)
  - [ ] Add SESSION tab to existing debug panel navigation
  - [ ] Create session cost summary component (total + breakdown)
  - [ ] Add per-interaction cost history table with timestamps
  - [ ] Implement real-time cost updates via Convex subscriptions
- [ ] Testing & Validation — <owner> (1d)
  - [ ] Unit tests for cost calculation accuracy
  - [ ] Integration tests for end-to-end cost tracking
  - [ ] E2E tests for debug panel cost display
  - [ ] Cost validation against provider documentation

## Scope
In scope
- STT, LLM, and TTS cost tracking with provider-specific pricing
- Per-interaction and session-level cost aggregation
- Real-time cost display in debug panel
- Cost calculation service with multiple provider support
- Session metrics (duration, interaction count)

Out of scope
- Cost budgeting and alerting (future sprint)
- Historical cost analytics and trends
- Cost optimization recommendations
- Multi-currency support (USD only)

## Features in this Sprint
- [ ] FEAT-022 — Cost Tracking & Budget Alarms (infra)
- [ ] FEAT-050 — Session Cost Debug Panel (frontend)
- [ ] FEAT-051 — Cost Calculation Service (backend)

## Acceptance Criteria
- [ ] All STT, TTS, and LLM interactions store accurate cost data in cents
- [ ] Session cost aggregation API returns breakdown by service type
- [ ] Debug panel SESSION tab shows real-time costs and session metrics
- [ ] Cost calculations match provider pricing documentation (±1% accuracy)
- [ ] Per-interaction cost history displays with timestamps
- [ ] Session duration and interaction count tracked accurately

## Risks & Mitigations
- Risk: Provider pricing changes breaking calculations · Mitigation: Versioned cost configs with fallback rates
- Risk: Token usage not available from all providers · Mitigation: Graceful fallback to estimated costs
- Risk: Floating point precision issues with cost calculations · Mitigation: Store costs in cents (integers)
- Risk: High database write volume from cost tracking · Mitigation: Batch cost updates where possible

## Dependencies
- Depends on features/sprints: SPR-008 (Session Summary), SPR-004 (STT/TTS)
- External: Provider API documentation for accurate pricing

## Technical Details
### Database Models
- Collections/Tables impacted: interactions, sessions
- New/changed fields: 
  - interactions.sttCostCents: number (optional, cost in cents)
  - interactions.llmCostCents: number (optional, cost in cents)
  - interactions.ttsCostCents: number (optional, cost in cents)
  - interactions.totalCostCents: number (optional, total cost in cents)
  - interactions.sttDurationMs: number (optional, audio duration)
  - interactions.llmTokensIn: number (optional, input tokens)
  - interactions.llmTokensOut: number (optional, output tokens)
  - interactions.ttsCharacters: number (optional, character count)
  - sessions.totalCostCents: number (optional, session total cost)
  - sessions.sttCostCents: number (optional, session STT cost)
  - sessions.llmCostCents: number (optional, session LLM cost)
  - sessions.ttsCostCents: number (optional, session TTS cost)
  - sessions.interactionCount: number (optional, total interactions)
  - sessions.durationMs: number (optional, session duration)
  - sessions.startTime: number (optional, session start timestamp)
  - sessions.endTime: number (optional, session end timestamp)
- Constraints/validation: Cost fields must be non-negative integers
- Indexes (read/write paths): sessions: [sessionId, updatedAt], interactions: [sessionId, createdAt]
- Migrations: Add new fields as optional, backfill plan: set to null initially
- Data retention: Cost data retained same as interaction data (30d default)

### Algorithmic Details
- Approach: Provider-specific cost calculation with fallback rates
- Cost storage: Store in cents to avoid floating point precision issues
- Aggregation: Sum costs by service type (STT/LLM/TTS) per session
- Latency targets: Cost calculation < 50ms, UI updates < 100ms

### Prompts & Rubrics
- N/A - No AI prompts required for cost tracking

## QA & Testing
- [ ] Unit tests updated/added for cost calculation service
- [ ] E2E happy path green (cost tracking through complete interaction)
- [ ] Load/SSE smoke test passes with cost tracking enabled
- [ ] Contract tests for cost API routes
- [ ] Cost accuracy validation tests against provider documentation

## Observability & SLOs
Targets (see Technical Overview §10)
- Cost calculation latency p95 < 50ms
- Session cost API p95 < 200ms
- Cost accuracy ±1% of provider rates

Checkpoints
- [ ] Dashboards exist/updated for cost metrics
- [ ] Alerts configured for cost calculation failures
- [ ] Structured logs include requestId, provider, modelId, tokens, cost, latency
- [ ] Cost tracking metrics: costs_calculated_total{provider,service}, cost_calculation_latency_ms

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

- Date: <YYYY-MM-DD> — Issue: <short summary> — Impact: <scope/users/services>
  - Detection: <alert/log/user report>
  - Fix: <what changed> — PR: <link> — Owner: <name>
  - Follow-up: <test/monitoring/doc action>
- Deviation from plan: <what changed and why>

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [ ] .env.example updated with cost calculation env vars
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for cost API endpoints

## Documentation
- [ ] API reference updated for cost endpoints (Core & AI)
- [ ] OpenAPI spec updated and linted for cost fields
- [ ] Examples added/verified (curl + TypeScript) for cost APIs
- [ ] Cross-links updated (PRD/Technical Overview) for cost tracking

## Post-sprint
- [ ] KPIs reviewed; compare to targets (cost accuracy, latency)
- [ ] Retrospective completed; action items filed
- [ ] Docs updated (PRD/Tech Overview/Runbooks) with cost tracking

## Change Log
- 2025-01-01 Created sprint page
- <YYYY-MM-DD> Updated scope
- <YYYY-MM-DD> Moved FEAT-XXX to SPR-YYY