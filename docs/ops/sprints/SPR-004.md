# Sprint SPR-004 — Audio Storage, STT/TTS & Voice Mode

End-to-end Audio/Object Storage, Speech-to-Text (STT), Text-to-Speech (TTS), and Voice Mode for chat. Includes S3-compatible storage with signed URLs, transcript persistence, and client/server wiring for microphone input and audio playback. Thorough testing, monitoring, documentation, and operational hygiene throughout.

## Meta
- Sprint ID: SPR-004
- Status: active
- Start date: 22/08/2025
- End date:
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Status Summary

- Storage presign implemented: signed PUT (upload) and GET (download) in `ui/src/app/api/v1/storage/audio/presign/route.ts`
- Smoke tests added and passing locally (upload + download); S3 CORS setup script in `ui/scripts/s3-setup-cors.mjs`
- CI workflow added: Storage Smoke (LocalStack) at `.github/workflows/storage-smoke.yml`
- Local dev env finalized in `ui/.env.local` for LocalStack S3; Clerk disabled locally (`CLERK_ENABLED=0`)
- OpenAPI updated: `docs/api/core/openapi.json`
- Monitoring docs expanded: presign + transcripts sections; metrics/log guidance
- Decisions recorded: LocalStack defaults, presign policy (15m), privacy/logging rules
- Next: wire transcripts to Convex; implement STT/TTS; Voice Mode end-to-end

## Objectives (Tick when achieved)
- [ ] Audio/Object Storage integrated (S3-compatible) with presigned upload/download, IAM least-privilege, SSE encryption, lifecycle retention
- [ ] STT pipeline in place: audio upload → transcription → transcript persisted and retrievable by `sessionId`/`groupId`
- [ ] TTS pipeline in place: assistant replies synthesized to audio and playable in the browser
- [ ] Chat Voice Mode working end-to-end (mic capture, upload, STT, reply, TTS playback)
- [ ] Comprehensive tests, dashboards, and updated documentation/runbooks

## Planned Tasks
- [ ] Audio/Object Storage (S3-compatible)
   - [ ] Provision bucket(s), IAM policy; configure optional custom S3 endpoint for dev
   - [x] Scaffold `POST /api/v1/storage/audio/presign` (mock) with CORS, auth toggle, metrics, structured logs
   - [x] Implement real S3 presign (AWS SDK v3) for signed PUT (set expirations/headers)
   - [x] Validate content-type/size; log `requestId`
   - [x] Env vars documented in `.env.example` (root and `ui/`)
   - [x] Smoke scripts (upload + download) and S3 CORS setup; CI Storage Smoke workflow
   - [ ] Unit/integration tests
- [ ] Transcript Storage (Session/Group)
   - [ ] Persist interaction `audioUrl` + transcript text and metadata in Convex
   - [x] Scaffold `GET /api/v1/transcripts` (stub) with auth, validation, pagination params, metrics, logs
   - [ ] Wire `GET /api/v1/transcripts` to Convex with pagination
   - [ ] Update `convex/schema.ts` and indexes; mocks updated
- [ ] STT Integration
   - [ ] Choose provider (Whisper/Transcribe/Deepgram/etc.) behind simple interface; env-driven
   - [ ] Accept `audio/webm|wav|mp3|m4a`; chunking or whole-file flow; error handling
   - [ ] Unit tests with fixtures; integration test from upload to transcript
- [ ] TTS Integration
   - [ ] Provider integration for streaming or chunked playback (e.g., `audio/mpeg`)
   - [ ] Client player component; fallbacks; latency measurements
   - [ ] Unit tests for provider adapter; integration test from text to audio playback
- [ ] Chat Voice Mode (AA)
   - [ ] UI mic capture (permission flow), recorder, and upload via presigned URL
   - [ ] Wire to STT, then normal chat pipeline, and TTS for assistant reply
   - [ ] Feature flag to enable/disable; accessibility considerations
   - [ ] Voice guardrails: max utterance length; disable concurrent mic sessions
- [ ] Monitoring & Runbooks
   - [ ] Metrics: storage ops, STT/TTS latency and error rates, bytes uploaded/downloaded
   - [ ] Dashboards and alerts (latency, error rate, storage space)
   - [ ] Runbooks: common failures (upload 403, presign expiry, MIME mismatch)
- [ ] Documentation
   - [ ] API reference (presign, transcript GETs, voice mode usage)
   - [ ] Examples (curl/TS) for upload and playback
   - [ ] Operational hygiene: env vars, IAM, lifecycle policies
   - Docs locations:
     - `docs/api/README.md`
     - `docs/api/core/reference.md` (Core API; presign + transcripts examples to add)
     - `docs/api/ai/reference.md` (STT/TTS endpoints and usage; TBD)
     - `docs/api/shared/headers.md`, `docs/api/shared/errors.md`

### Progress notes

- Monitoring docs updated with new sections for this sprint:
  - Added `docs/ops/monitoring.md` §10 (Audio Presign) and §11 (Transcripts) with metrics and log examples
- API scaffolds added in Next.js:
  - `ui/src/app/api/v1/storage/audio/presign/route.ts` (real S3 presign, CORS, auth toggle, metrics, logs)
  - `ui/src/app/api/v1/transcripts/route.ts` (stub list, auth, validation, metrics, logs)
- OpenAPI updated in `docs/api/core/openapi.json` for both endpoints
- Env examples updated in root and `ui` `.env.example` with S3, STT/TTS, and guardrails

- UI E2E baseline (Playwright): 16 passed, 2 skipped; add audio storage smoke next

- 2025-08-23: LocalStack S3 enabled and storage smoke passed end-to-end. Presign PUT/GET return valid URLs; upload and download both 200; object visible in bucket. Presign route configured with `requestChecksumCalculation`/`responseChecksumValidation` = `WHEN_REQUIRED` for compatibility. Added `ui/docker-compose.local.yml` to spin up LocalStack.

Additional updates (2025-08-22):
- Presign route now uses AWS SDK v3 when `STORAGE_PROVIDER=s3` and bucket configured; falls back to mock otherwise
- Added smoke scripts: `ui/scripts/storage-presign-smoke.mjs`, `ui/scripts/transcripts-smoke.mjs` and wired npm scripts

## API Endpoints (scaffolded)

- `POST /api/v1/storage/audio/presign`
  - File: `ui/src/app/api/v1/storage/audio/presign/route.ts`
  - Auth via `requireAuth()` (Clerk-gated when `CLERK_ENABLED=1`), CORS, metrics, structured logs
  - Current: uses AWS SDK v3 to presign when S3 is configured; falls back to mock payload otherwise
- `GET /api/v1/transcripts`
  - File: `ui/src/app/api/v1/transcripts/route.ts`
  - Auth via `requireAuth()`, pagination params (`sessionId` required; `groupId`, `limit`, `cursor` optional), metrics, logs
  - Current: returns empty stub list; wire to Convex transcript reads
- OpenAPI updated: `docs/api/core/openapi.json` includes both paths and schemas

## Configuration (.env)

Server-only unless noted otherwise. See examples in `coach-up-frontend/.env.example` and `coach-up-frontend/ui/.env.example`.

- Storage (S3-compatible)
  - `STORAGE_PROVIDER=s3`
  - `S3_BUCKET_AUDIO`, `S3_REGION`, `S3_ENDPOINT_URL` (for LocalStack/MinIO), `S3_FORCE_PATH_STYLE=1`
  - `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`
- Speech Providers (STT/TTS)
  - `STT_PROVIDER=whisper|azure|openai`
  - `TTS_PROVIDER=openai|azure|elevenlabs`
  - `OPENAI_API_KEY`, `AZURE_SPEECH_KEY`, `AZURE_SPEECH_REGION`, `ELEVENLABS_API_KEY`
  - `TTS_VOICE_ID`, `TTS_FORMAT=audio/mpeg`
- Voice Guardrails
  - `VOICE_MAX_UTTERANCE_MS=15000`
- Auth gating flags
  - `CLERK_ENABLED=0|1`, `CLERK_PROTECT_ALL=0|1`
  - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`, `CLERK_SECRET_KEY`
  - `NEXT_PUBLIC_CLERK_SIGN_IN_URL`, `NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL`, `NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL`

## Monitoring & Logs

- See `docs/ops/monitoring.md`:
  - Section 10: Audio Storage Presign API
  - Section 11: Transcripts API
- Key metrics (service: next): `next.request.count`, `next.request.errors`, `next.request.latency_ms`
- Log fields: `requestId`, `route`, `status`, `latencyMs`, and whitelisted params only; never log raw IDs or credentials

## Decisions

- Dev storage: use LocalStack S3 by default for local development
  - Set `S3_ENDPOINT_URL=http://localhost:4566` and `S3_FORCE_PATH_STYLE=1`
  - Create bucket per env (e.g., `coachup-audio-local`, `coachup-audio-staging`, `coachup-audio-prod`)
  - Configure CORS to allow presigned PUT with required headers and GET for playback
- Presign policy
  - Expiration: 15 minutes
  - Allowed content types: `audio/webm`, `audio/mpeg`, `audio/wav`, `audio/mp4`
  - Enforce `contentLength` bounds (client-provided; server validates)
- Privacy & logging: never log raw object keys or credentials; log only whitelisted params and hashed IDs

## Next Milestones

- Harden S3 storage:
  - Bucket CORS for PUT/GET, lifecycle retention, optional SSE
  - Presign-GET for download: completed; add E2E download check
  - Add integration tests for presign + upload with LocalStack
- Wire transcripts data source
  - Define Convex schema/indexes; persist transcripts on STT completion
  - Back `GET /api/v1/transcripts` with real pagination
- Developer tooling
  - Add smoke scripts (presign → upload → transcripts) and npm tasks
  - Add curl/TS examples to `docs/api/core/reference.md`
- Observability
  - Add dashboards and basic alerts; wire metrics emission to routes/providers

## Open Questions

- STT/TTS defaults for dev: Whisper local vs OpenAI/Azure? Cost/latency trade-offs
- Audio formats to support beyond `webm/mp3/wav/m4a`; any transcoding needed server-side?
- Default retention for raw audio (7–30 days?) and transcripts (longer?)
- Allow unauthenticated presign in local only (`CLERK_ENABLED=0`) or always require auth?

## Test Plan (smoke)

- Presign
  - POST `/api/v1/storage/audio/presign` with `{ contentType, contentLength }` → 200 with URL + headers
- Upload (manual)
  - PUT the audio file to the returned presigned URL with required headers → 200/204
- Transcripts
  - GET `/api/v1/transcripts?sessionId=...&limit=25` → 200 with `items` array and pagination
- TTS (when wired)
  - Synthesize a short reply and verify browser playback

## Scope
In scope
- Audio/Object Storage with signed URLs and retention
- STT and TTS integrations via pluggable providers
- Chat Voice Mode UX (mic capture to audio playback)
- Transcript persistence and retrieval APIs

Out of scope
- Provider benchmarking and model comparisons (SPR-007)
- Detailed analytics/dashboard polish (charts beyond MVP)

## Features in this Sprint
List feature IDs from Features CSV (pipe-separate multiple)
- [ ] FEAT-025 — Audio Object Storage (S3-Compatible) (infra)
- [ ] FEAT-043 — STT Mic Capture & Submit (frontend)
- [ ] FEAT-044 — STT Provider Integration (ai)
- [ ] FEAT-045 — TTS Provider Integration (ai)
- [ ] FEAT-016 — Voice TTS Playback (frontend)
- [ ] FEAT-049 — Mock STT Path for E2E (qa)
 - [ ] FEAT-048 — Voice Mode Guardrails (max utterance, concurrent mic) (infra)

## Acceptance Criteria
- [ ] `POST /api/v1/storage/audio/presign` returns valid signed PUT URL (mock + S3)
- [ ] Browser can record and upload audio, then receive transcript via STT
- [ ] Assistant replies rendered as audio via TTS; playback works across major browsers
- [ ] Transcripts retrievable by `sessionId`/`groupId`; pagination and limits enforced
- [ ] Metrics and dashboards in place for storage, STT, TTS; alerts on latency/errors
- [ ] Docs updated (API reference/OpenAPI/examples/runbooks); env vars documented

## Risks & Mitigations
- Risk: Browser codec incompatibilities (webm/mp3/aac) · Mitigation: accept multiple formats; detect/convert server-side when needed
- Risk: STT/TTS provider latency/cost variance · Mitigation: pluggable providers; timeouts, retries, and fallbacks
- Risk: S3 permissions or CORS misconfig · Mitigation: least-privilege IAM, automated bucket policy, and tested CORS rules

## Dependencies
- Depends on features/sprints: SPR-003 (auth/schema/transcript APIs)
- External: S3-compatible storage, chosen STT/TTS provider(s), Clerk (auth)

## Technical Details
### Database Models
- Collections/Tables impacted: Session, Interaction, Transcript (if separate), Assessment
- New/changed fields: `interactions.audioUrl?: string`, `interactions.transcript?: string`, `createdAt`
- Constraints/validation: audioUrl must be http(s); size/type checks; transcript length caps
- Indexes (read/write paths): by `sessionId`, `groupId`, `createdAt`
- Migrations: add fields/indexes; backfill NA
- Data retention: raw audio per privacy window (e.g., 7–30d); transcripts retained longer

### Algorithmic Details
- Approach: provider adapters for STT/TTS with uniform interface and error typing
- Rubric Version: NA
- Latency targets: STT p95 < 4s for 10s audio; TTS start < 800ms; upload PUT p95 < 1.5s

### Prompts & Rubrics
- NA

## QA & Testing
- [ ] Unit tests: presign route, schema validations, provider adapters (STT/TTS)
- [ ] Integration tests: upload → STT → transcript persist; text → TTS → playback
- [ ] E2E: voice chat happy path (mic permission → upload → transcript → reply → TTS)
- [ ] Load tests: parallel uploads and STT; sustained TTS playback without glitches
- [ ] Contract tests: API routes (presign, transcripts GET)

Current status: Playwright UI E2E 16 passed, 2 skipped; audio storage smoke tests added (local + CI) and passing

## Observability & SLOs
Targets (see Technical Overview §10)
- Realtime chat p95 TTFT < 1.2s; full-turn < 2.5s
- Assessment p95 completion < 8s

Checkpoints
- [ ] Dashboards built/linked: storage ops, STT/TTS latencies, upload sizes
- [ ] Alerts for storage failures/latency, STT/TTS error rates
- [ ] Structured logs include requestId, userId, sessionId, content-type, object key

## CI & Automation

- OpenAPI lint (frontend): `.github/workflows/openapi-lint.yml`
- Monitoring validation (root): `.github/workflows/monitoring-validate.yml`
- Storage Smoke (LocalStack): `.github/workflows/storage-smoke.yml`
- Next: add route tests and smoke scripts to CI for presign/upload/transcripts

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

- Date: <YYYY-MM-DD> — Issue: <short summary> — Impact: <scope/users/services>
  - Detection: <alert/log/user report>
  - Fix: <what changed> — PR: <link> — Owner: <name>
  - Follow-up: <test/monitoring/doc action>
- Deviation from plan: <what changed and why>

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [ ] .env.example updated if new env vars added
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for new/changed endpoints

## Documentation
- [ ] API reference updated for endpoints touched (Core & AI)
- [ ] OpenAPI spec updated and linted
- [ ] Examples added/verified (curl + TypeScript)
- [ ] Cross-links updated (PRD/Technical Overview)

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed

## Change Log
- 22/08/2025 Created sprint page
 - 22/08/2025 Status set to active; start date recorded; overview updated
 - 22/08/2025 API scaffolds added: `POST /api/v1/storage/audio/presign` (mock) and `GET /api/v1/transcripts` (stub)
 - 22/08/2025 OpenAPI updated (`docs/api/core/openapi.json`) with presign and transcripts paths/schemas
 - 22/08/2025 Env examples updated in root and `ui/` with S3/STT/TTS/guardrails vars
 - 22/08/2025 Monitoring notes added in `docs/ops/monitoring.md` (§10 Presign, §11 Transcripts)
 - 22/08/2025 Sprint doc expanded: API Endpoints, Configuration (.env), Monitoring & Logs, Decisions, Test Plan
 - 23/08/2025 Storage: presign GET added; smoke tests for upload/download and S3 CORS setup implemented; LocalStack `.env.local` finalized; CI workflow `storage-smoke.yml` added; local smokes passing
