# Sprint SPR-004 — Monitoring & Guardrails

Establish monitoring baseline (metrics/logs/dashboards), rate limiting and circuit breakers, requestId propagation, cost tracking, and privacy redaction pipeline.

## Meta
- Sprint ID: SPR-004
- Status: planned
- Start date: <YYYY-MM-DD>
- End date: <YYYY-MM-DD>
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Structured logging + metrics emitted for key paths
- [ ] RequestId propagated end-to-end
- [ ] Rate limiting + circuit breakers in place
- [ ] Cost tracking and budget alarms
- [ ] Privacy redaction pipeline for logs/events

## Planned Tasks
- [ ] Instrumentation Baseline — <owner> (<estimate>)
   - [ ] Emit metrics for chat/assessment paths
   - [ ] JSON logs with requestId/userId/sessionId
- [ ] RequestId Propagation — <owner> (<estimate>)
   - [ ] Client → Next.js → FastAPI → provider; include in logs
- [ ] Rate Limiting & Circuit Breakers — <owner> (<estimate>)
   - [ ] Per-user quotas; backoff; breaker thresholds
- [ ] Cost Tracking & Budget Alarms — <owner> (<estimate>)
   - [ ] Compute tokens/cost; daily budgets; alerts
- [ ] Privacy Redaction — <owner> (<estimate>)
   - [ ] Remove PII from logs; retention policies

## Scope
In scope
- Metrics/logs, rate limiting, breakers, requestId, cost, redaction

Out of scope
- UI polish for dashboards (can be minimal)
- Provider abstraction/benchmarking (SPR-006)

## Features in this Sprint
List feature IDs from Features CSV (pipe-separate multiple)
- [ ] FEAT-019 — Monitoring Baseline (Metrics/Logs) (infra)
- [ ] FEAT-020 — Rate Limiting & Circuit Breakers (infra)
- [ ] FEAT-026 — RequestId Propagation End-to-End (infra)
- [ ] FEAT-022 — Cost Tracking & Budget Alarms (infra)
- [ ] FEAT-023 — Privacy Redaction Pipeline (infra)

## Acceptance Criteria
- [ ] Dashboards show p95 TTFT/full-turn and error rates
- [ ] 429 with Retry-After when limits exceeded
- [ ] Breakers trip on provider errors/timeouts; recover when healthy
- [ ] Budget alerts fire above threshold; cost reported daily

## Risks & Mitigations
- Risk: High metric cardinality · Mitigation: use tags selectively, sample
- Risk: Over-aggressive limits · Mitigation: start conservative, feature-flag thresholds

## Dependencies
- Depends on features/sprints: SPR-001 (chat), SPR-002 (assessments)
- External: NA

## Technical Details
### Database Models
- Collections/Tables impacted: optional PromptRun/cost events if used
- New/changed fields: requestId propagation in logs/records
- Constraints/validation: ensure redaction before log write
- Indexes (read/write paths): by requestId, createdAt (if storing events)
- Migrations: NA — Backfill plan: NA
- Data retention: strict retention for logs and raw audio

### Algorithmic Details
- Approach: token/cost estimations per provider; exponential backoff; breaker half-open
- Rubric Version: NA
- Latency targets: maintain SLOs during load and failure tests

### Prompts & Rubrics
- NA

## QA & Testing
- [ ] Load tests: 20–50 concurrent SSE streams within SLOs
- [ ] Rate limit tests: verify 429 and Retry-After
- [ ] Chaos: inject 500/timeouts; verify breaker and recovery
- [ ] Cost calc unit tests vs known inputs

## Observability & SLOs
Targets (see Technical Overview §10)
- Realtime chat p95 TTFT < 1.2s; full-turn < 2.5s
- Assessment p95 completion < 8s

Checkpoints
- [ ] Dashboards built/linked
- [ ] Alerts for latency/errors/budget
- [ ] Structured logs include requestId, tokens, cost

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

- Date: <YYYY-MM-DD> — Issue: <short summary> — Impact: <scope/users/services>
  - Detection: <alert/log/user report>
  - Fix: <what changed> — PR: <link> — Owner: <name>
  - Follow-up: <test/monitoring/doc action>
- Deviation from plan: <what changed and why>

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [ ] .env.example updated if new env vars added
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for new/changed endpoints

## Documentation
- [ ] API reference updated for endpoints touched (Core & AI)
- [ ] OpenAPI spec updated and linted
- [ ] Examples added/verified (curl + TypeScript)
- [ ] Cross-links updated (PRD/Technical Overview)

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed

## Change Log
- 2025-08-19 Created sprint page
