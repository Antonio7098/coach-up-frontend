# Sprint SPR-002 — Assessments v1

Implement Assessments v1: Convex data model, multi-turn assessment pipeline with rubric v1, and end-of-session summary generation + UI display.

## Meta
- Sprint ID: SPR-002
- Status: in progress
- Start date: 19/08/2025
- End date: <DD/MM/YYYY>
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [x] Assessment Data Model v1 in Convex with indexes
- [ ] Multi-turn assessment job (buffering + triggers)
- [ ] Rubric v1 implemented and versioned
- [ ] End-of-session summary generated and rendered in UI

## Planned Tasks
- [ ] Assessment Data Model — (<estimate>)
   - [x] Schema, indexes, validation rules in Convex
   - [x] Read/write functions + types
- [ ] Multi-turn Assessment Job — (<estimate>)
   - [ ] Trigger heuristics and grouping (groupId)
   - [ ] Background worker + batching
- [ ] Rubric v1 — (<estimate>)
   - [x] Define categories, scoring buckets (RUBRIC_V1_CATEGORIES stubbed)
   - [ ] Unit tests and golden cases
- [ ] Summary Generation & UI — (<estimate>)
   - [ ] Generate session summary document
   - [x] Display in post-chat view (Assessments panel on /chat)

## Scope
In scope
- Per-interaction and multi-turn assessments
- Session summary generation and UI

Out of scope
- Advanced analytics and dashboards (SPR-005)
- Provider benchmarking (SPR-006)

## Features in this Sprint
List feature IDs from Features CSV (pipe-separate multiple)
- [x] FEAT-010 — Assessment Data Model v1 (backend)
- [ ] FEAT-011 — Multi-turn Assessment Job v1 (ai)
- [ ] FEAT-008 — End-of-Session Summary v1 (ai)
- [x] FEAT-009 — Summary Display UI (frontend)
- [ ] FEAT-028 — Rubric v1 for Assessments (ai)

## Acceptance Criteria
- [ ] Assessments are created with correct kind/category and validated
- [ ] Multi-turn assessments share a groupId and reference correct interactionIds
- [ ] Session summary is produced and visible in the UI

## Risks & Mitigations
- Risk: Over-triggering assessments · Mitigation: conservative heuristics + rate limits
- Risk: Rubric instability · Mitigation: lock rubric v1, add tests and versioning

## Dependencies
- Depends on features/sprints: SPR-001 (chat interactions exist)
- External: NA

## Technical Details
See design details in [Assessments v1 — Plan](../planning/assessments.md).
### Database Models
- Collections/Tables impacted: Assessment, Interaction, UserSession
- New/changed fields: Assessment.kind/category/score/errors/tags/groupId/rubricVersion
- Constraints/validation: kind/category combos; ids presence by kind; score ranges
- Indexes (read/write paths): Assessment by userId, sessionId, focusId, kind, createdAt, groupId
- Migrations: initial Assessment collection — Backfill plan: NA
- Data retention: Assessments retained; raw audio retention handled in storage sprint

### Algorithmic Details
- Approach: lightweight trigger → enqueue background analysis for multi-turn; per-interaction optional
- Rubric Version: v1
- Latency targets: Background completion p95 < 8s

### Prompts & Rubrics
- Prompt names/links: assessment-per-turn, assessment-multi-turn, summary
- Judge/rubric key points: correctness, clarity, minimality

## QA & Testing
- [x] Unit tests
  - Next.js API routes (ui)
    - `ui/src/app/api/assessments/run/route.ts` — file: `ui/tests/unit/api.assessments.run.spec.ts`
    - `ui/src/app/api/assessments/convex/[sessionId]/route.ts` — file: `ui/tests/unit/api.assessments.convex.get.spec.ts`
    - `ui/src/app/api/assessments/convex/finalize/route.ts` — file: `ui/tests/unit/api.assessments.convex.finalize.spec.ts`
  - Tools: Vitest (`ui/vitest.config.ts`), Convex client mocked
- [x] Contract tests
  - Next.js ↔ FastAPI AI — passing
    - Endpoints: `POST /assessments/run`, `GET /assessments/{sessionId}`, `GET /chat/stream` (SSE)
    - Tests:
      - `ui/tests/e2e/api.contract.assessments.run.spec.ts`
      - `ui/tests/e2e/api.contract.assessments.get.spec.ts`
      - `ui/tests/e2e/api.contract.chat.sse.spec.ts`
    - Runner: `ui/playwright.config.ts` with dual webServer setup (uvicorn + Next)
      - FastAPI (uvicorn): `python3 -m uvicorn app.main:app --host 127.0.0.1 --port 8001` (cwd `../../coach-up-ai-api`)
      - Next.js: `npm run dev:wasm`
      - Env: `CSS_TRANSFORMER_WASM=1`, `AI_API_BASE_URL=http://127.0.0.1:8001`, `MOCK_CONVEX=1`
  - Next.js ↔ Convex — added
    - Endpoints:
      - `POST /api/assessments/convex/finalize`
      - `GET  /api/assessments/convex/{sessionId}`
    - Tests:
      - `ui/tests/e2e/api.convex.persistence.spec.ts` (smoke)
      - `ui/tests/e2e/api.contract.assessments.convex.after-run.spec.ts` (contract; ties AI run → Convex baseline)
    - Notes:
      - E2E uses an in-memory Convex mock when `MOCK_CONVEX=1` to avoid requiring a Convex dev server in CI/local.
      - Real Convex runs are supported via a dedicated Playwright project: `chromium:real-convex`.
      - Run locally/CI with: `npm run test:e2e:real-convex` and set `CONVEX_URL=https://<your-dev>.convex.cloud` (or set `ui/.env.local` with `MOCK_CONVEX=0`, `CONVEX_URL`, `NEXT_PUBLIC_CONVEX_URL`).
      - Verified: 7 Playwright tests passed against real Convex (cloud dev).
      - Quickstart added in `ui/README.md` under “Real Convex Quickstart”.
- [x] E2E: complete a scenario and see summary (Playwright)
- [x] E2E smoke: home renders (Playwright)
    - Test: `ui/tests/e2e/home.spec.ts`
    - Runner config: `ui/playwright.config.ts`
      - `testDir: ./tests/e2e`
      - `webServer.env.CSS_TRANSFORMER_WASM=1` to force WASM Lightning CSS
    - UI E2E: `ui/tests/e2e/ui.chat.assessments.summary.spec.ts` (verifies Summary panel appears on /chat)
    - PostCSS config: `ui/postcss.config.mjs`
      - Uses plugin mapping shape: `plugins: { '@tailwindcss/postcss': {} }`
    - Lightning CSS (WASM path):
      - Dev dep: `lightningcss-wasm`
      - Shim: `node_modules/lightningcss/pkg/index.js` → `module.exports = require('lightningcss-wasm');`
      - Persisted via `ui/scripts/postinstall-lightningcss-wasm-shim.cjs` and `package.json#scripts.postinstall`
    - Local dev: `npm run dev:wasm`
    - Status: Unit tests (9) passed; Contract tests (3) passed; E2E smoke (1) passed; duplicate lockfile warning resolved (`ui/package-lock.json` removed; `ui/.npmrc` sets `package-lock=false`)
  - CI: Playwright E2E workflow (smoke + contracts)
    - File: `coach-up-frontend/.github/workflows/playwright-e2e.yml`
    - Smoke job: sets `SKIP_AI_CONTRACTS=1` to skip AI contract tests and run UI-only
    - Contracts job: runs dual servers via `ui/playwright.config.ts` webServer array (uvicorn + Next)
    - Toggle: `SKIP_AI_CONTRACTS` skips AI contract tests. In config, servers are conditional on `SKIP_AI_CONTRACTS` being `1|true`; tests themselves are skipped when the var is set.
  - [ ] Load: batch 20 multi-turn assessments < 8s p95

## Observability & SLOs
Targets (see Technical Overview §10)
- Realtime chat p95 TTFT < 1.2s; full-turn < 2.5s
- Assessment p95 completion < 8s

Checkpoints
- [ ] Dashboards include assessment latencies and error rates
- [ ] Alerts on backlog/timeout thresholds
- [ ] Structured logs include requestId, groupId, rubricVersion

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

- Date: 19/08/2025 — Issue: Next.js API proxy JSON parsing caused 400 “Invalid JSON body” — Impact: UI proxy POST /api/assessments/run
  - Detection: curl tests to UI proxy returned 400
  - Fix: Switched proxy to forward raw request body and set X-Request-Id; added body pass-through handling
  - Follow-up: Validate POST end-to-end, add contract tests; ensure Content-Type preserved
- Date: 20/08/2025 — Issue: Upstream POST returned 422 JSON decode error; UI proxy intermittently 502/404 — Impact: End-to-end verification
  - Detection: curl against 127.0.0.1:8001 and UI proxy; logs show JSON decode error
  - Fix: Forward ArrayBuffer body and headers; confirmed upstream /health and GET summary OK; POST still under investigation
  - Follow-up: Force Content-Type header, explicitly re-encode body, and/or use request.clone().text(); consider defaulting proxy to 127.0.0.1:8001 during local dev
- Date: 20/08/2025 — Issue: OpenAPI lint failed due to missing tags — Impact: API documentation
  - Detection: OpenAPI lint check failed
  - Fix: Added missing tags to OpenAPI spec
  - Follow-up: Verify API documentation is updated correctly

- Date: 20/08/2025 — Issue: Next dev server failed due to missing native Lightning CSS binary — Impact: E2E blocked
  - Detection: Playwright webServer logs showed `Cannot find module '../pkg'` from `lightningcss/node/index.js`
  - Fix: Switched to WASM path — installed `lightningcss-wasm`, added shim at `node_modules/lightningcss/pkg/index.js`, set `CSS_TRANSFORMER_WASM=1` in `ui/playwright.config.ts`, updated PostCSS config mapping
  - Follow-up: Keep WASM for portability or switch to native binary in CI later

- Date: 20/08/2025 — Resolution: POST /assessments/run JSON body handling fixed end-to-end — Impact: Unblocked assessments via UI and direct API
  - Detection: 400s when JSON was incorrectly quoted in curl; verified happy-path with stdin/--json patterns
  - Fix: AI API reads raw body once and tolerates JSON or form; UI proxy now forwards query strings and preserves raw body; body-derived sessionId is appended as QS when present; verified 200 from both endpoints
  - Follow-up: Remove temporary stdout debug print (done); add robust curl examples to docs (done); proceed to Convex persistence

- Date: 20/08/2025 — Issue: React hydration mismatch on `/chat` due to server/client `SESSION_ID` divergence — Impact: UI warning and unstable rendering
  - Detection: Hydration warning in DevTools; `SESSION_ID` generated at module scope with `crypto.randomUUID()`/`Math.random()` differing between SSR and client
  - Fix: Generate `sessionId` client-side in `useEffect`, persist in `sessionStorage` (`chatSessionId`), and gate UI actions until ready; aligned AI API base URL default to `http://127.0.0.1:8001`
  - Follow-up: Add regression test for non-deterministic SSR values in components rendering IDs; document pattern in UI README

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [X] .env.example updated if new env vars added
- [x] Convex dev provisioned; `.env.local` contains `CONVEX_DEPLOYMENT`
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for new/changed endpoints

## Documentation
Notes:
- Design doc: [Assessments v1 — Plan](../planning/assessments.md)
- [x] API reference updated for endpoints touched (AI: chat + assessments)
- [x] OpenAPI spec updated and linted
- [x] Examples added/verified (curl + TypeScript)
- [x] UI README: Real Convex Quickstart (env, dev/deploy, E2E project)
- [ ] Cross-links updated (PRD/Technical Overview)

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed

## Change Log
- 19/08/2025 Created sprint page; sprint started (in progress)
- 19/08/2025 Added AI API assessments endpoints (run/get) stubs; updated OpenAPI tags
- 19/08/2025 Added frontend proxy routes for assessments; updated AI API docs with curl/TS examples; snapshotted OpenAPI
- 19/08/2025 Implemented Assessments panel on /chat to run and fetch summary
- 19/08/2025 Added Convex assessments schema + function stubs; updated .gitignore for Convex artifacts
- 19/08/2025 Enhanced AI API rubric stub with RUBRIC_V1_CATEGORIES; enriched GET summary response
- 20/08/2025 OpenAPI lint passed (frontend); continued proxy debugging for POST body handling
- 20/08/2025 Fixed POST /assessments/run JSON handling end-to-end (AI + UI proxy); proxy now forwards query strings; removed temporary stdout debug; docs updated with robust curl examples; verified 200 OK via both paths
- 20/08/2025 E2E (Playwright) smoke test passing using Lightning CSS WASM; PostCSS mapping fixed; added WASM shim + postinstall; added `dev:wasm`; cleaned duplicate lockfile
- 20/08/2025 Added Playwright contract tests (AI run/get + chat SSE) and dual webServer setup (uvicorn + Next); all passing locally
- 20/08/2025 Added GitHub Actions Playwright E2E workflow (smoke + contracts) with `SKIP_AI_CONTRACTS` toggle; documented in sprint
- 20/08/2025 Added Convex-backed assessment persistence E2E (smoke) using `MOCK_CONVEX=1`; added contract test tying AI run → Convex baseline; updated Playwright config and sprint docs
- 20/08/2025 Added Playwright project `chromium:real-convex` + npm script; `ui/README.md` Real Convex Quickstart; verified E2E (7) passing against cloud Convex; provisioned Convex dev (`CONVEX_DEPLOYMENT` in `.env.local`)
- 20/08/2025 Added UI E2E on /chat verifying Summary panel renders after "Run Assessment"; docs updated with E2E toggles
- 20/08/2025 Fixed React hydration error on `/chat` by generating `sessionId` client-only and persisting in `sessionStorage`; updated `ui/src/app/chat/page.tsx`; set AI API default to `http://127.0.0.1:8001`
