# Sprint SPR-003 — Auth & Data

Establish authentication with Clerk, baseline Convex schema, audio object storage, and session transcript storage to support MVP flows.

## Meta
- Sprint ID: SPR-003
- Status: in_progress
- Start date: 21/08/2025
- End date:
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Auth (Clerk) integrated and protecting routes/APIs
- [ ] Convex schema baseline created and type-safe
- [ ] Session transcript storage working (metadata + blobs)
- [ ] Convex Session State & Event Log (sessions/interactions/events persisted)
- [ ] Privacy: only hashed trackedSkillId (trackedSkillIdHash) propagated to logs/storage; raw IDs never logged/persisted

## Planned Tasks
- [ ] Clerk Integration
   - [ ] Configure Clerk and protect app routes/API routes
   - [ ] Add user provisioning and local dev setup
- [ ] Convex Schema Setup
   - [ ] Define core tables (User, UserSession, Interaction)
   - [ ] Create indexes and types; add validation
- [ ] Audio/Object Storage
   - [ ] S3-compatible bucket, IAM/policy
   - [ ] Upload path conventions and signed URLs
- [ ] Session Transcript Storage
   - [ ] Persist interactions and metadata
   - [ ] Retrieval APIs for dashboard/summary

- [ ] Convex Session State & Event Log
   - [ ] Define tables: `sessions`, `interactions`, `events`, and `assessments` summary
   - [ ] Indexes: by `userId`, `sessionId`, `groupId`, `createdAt`
   - [ ] Functions: `logEvent`, `appendInteraction`, `updateSessionState`
   - [ ] Persist assessment summary via callback write path
   - [ ] Runtime validations (ids, kinds, categories, score range)
   - [ ] Unit tests for write paths and indexes

## Scope
In scope
- Auth gating, schema, object storage, transcript storage
- Convex session state and event log; assessment summary persistence

Out of scope
- Detailed analytics/dashboard (SPR-005)
- Provider abstraction/benchmarking (SPR-006)

## Features in this Sprint
List feature IDs from Features CSV (pipe-separate multiple)
- [ ] FEAT-014 — Auth (Clerk) Integration (backend)
- [ ] FEAT-024 — Convex Schema Setup (backend)
- [ ] FEAT-025 — Audio Object Storage (S3-Compatible) (infra)
- [ ] FEAT-007 — Session Transcript Storage (backend)
- [ ] FEAT-032 — Convex Session State & Event Log (backend)

## Acceptance Criteria
- [ ] Users can sign in and access protected areas
- [ ] Schema exists with indexes; basic CRUD validated
- [ ] Interactions stored and retrievable; audio objects persisted
- [ ] Events persisted with `requestId`, `userId`, `sessionId`, `groupId`
- [ ] Assessment summaries persisted and queriable by `sessionId` and `groupId`
- [ ] Privacy: only hashed trackedSkillId appears in logs/storage; never the raw ID

## Risks & Mitigations
- Risk: Auth misconfiguration · Mitigation: dev/prod keys, test flows, runbook
- Risk: Data model churn · Mitigation: start minimal, evolve with migrations

## Dependencies
- Depends on features/sprints: SPR-002 (assessment payload shape & rubric v1)
- External: Clerk, S3-compatible storage
- Upstream: AI API propagates `trackedSkillIdHash` for privacy-preserving observability; Convex write paths should accept/record hash when provided

## Technical Details
### Database Models
- Collections/Tables impacted: User, UserSession, Interaction
- New/changed fields: define minimal fields; add createdAt, userId indexes
- Constraints/validation: required fields; size limits
- Indexes (read/write paths): by userId, sessionId, createdAt
- Migrations: initial schema — Backfill plan: NA
- Data retention: audio objects per privacy window; transcripts retained

### Object Storage (S3-compatible)
- Definition: Any object storage that implements the Amazon S3 API (e.g., AWS S3, MinIO, Cloudflare R2, LocalStack for dev). We will use S3-compatible clients and signed URL flows, so provider choice is flexible.
- Bucket naming: One bucket per environment to keep isolation and policies simple, e.g., `coachup-audio-dev`, `coachup-audio-staging`, `coachup-audio-prod`.
- Object key convention: `u/{userId}/s/{sessionId}/{ts}/{basename}`
  - Examples: `u/clk_123/s/sess_456/1692540060000/audio.wav` or `u/clk_123/s/sess_456/1692540060000/transcript.json`
  - Rationale: predictable partitioning by user and session; easy lifecycle policies and selective deletes.
- Signed URLs: Use pre-signed PUT for upload and GET for retrieval; restrict content-type and size; set short expirations (e.g., 10 minutes).
- Security/retention: Apply least-privilege IAM; enable server-side encryption; configure lifecycle rules to expire raw audio per privacy window.

### Algorithmic Details
- Approach: none — structural sprint
- Rubric Version: NA
- Latency targets: API p95 < 500ms for storage ops

### Prompts & Rubrics
- NA

## QA & Testing
- [ ] Unit tests for Convex functions
- [ ] E2E: sign-in, create session, store interaction
- [ ] Upload/download smoke tests for audio
- [ ] Contract tests for protected API routes

## Observability & SLOs
Targets (see Technical Overview §10)
- Realtime chat p95 TTFT < 1.2s; full-turn < 2.5s
- Assessment p95 completion < 8s

Checkpoints
- [ ] Dashboards include auth errors and storage metrics
- [ ] Alerts on storage failures/latency
- [ ] Structured logs include requestId, userId, and trackedSkillIdHash (when provided)

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

- Date: <YYYY-MM-DD> — Issue: <short summary> — Impact: <scope/users/services>
  - Detection: <alert/log/user report>
  - Fix: <what changed> — PR: <link> — Owner: <name>
  - Follow-up: <test/monitoring/doc action>
- Deviation from plan: <what changed and why>

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [ ] .env.example updated if new env vars added
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for new/changed endpoints

## Documentation
- [ ] API reference updated for endpoints touched (Core & AI)
- [ ] OpenAPI spec updated and linted
- [ ] Examples added/verified (curl + TypeScript)
- [ ] Cross-links updated (PRD/Technical Overview)

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed

## Change Log
- 2025-08-19 Created sprint page
- 2025-08-21 Added FEAT-032 and seeded Convex session state & event log plan
- 21/08/2025 Status set to in_progress; start date recorded; clarified S3-compatible storage and bucket naming; added privacy objective for trackedSkillIdHash
