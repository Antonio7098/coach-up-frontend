# Sprint SPR-003 — Auth & Data

Establish authentication with Clerk, baseline Convex schema, audio object storage, and session transcript storage to support MVP flows.

## Meta
- Sprint ID: SPR-003
- Status: in_progress
- Start date: 21/08/2025
- End date:
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Auth (Clerk) integrated and protecting routes/APIs
- [ ] Convex schema baseline created and type-safe
- [ ] Session transcript storage working (metadata + blobs)
- [ ] Convex Session State & Event Log (sessions/interactions/events persisted)
- [x] Privacy: only hashed trackedSkillId (trackedSkillIdHash) propagated to logs/storage; raw IDs never logged/persisted

## Planned Tasks
- [ ] Clerk Integration
   - [ ] Configure Clerk and protect app routes/API routes
   - [ ] Add user provisioning and local dev setup
- [ ] Convex Schema Setup
   - [ ] Define core tables (User, UserSession, Interaction)
   - [ ] Create indexes and types; add validation
- [ ] Audio/Object Storage
   - [ ] S3-compatible bucket, IAM/policy
   - [ ] Upload path conventions and signed URLs
- [ ] Session Transcript Storage
   - [ ] Persist interactions and metadata
   - [x] Retrieval APIs for dashboard/summary
- [ ] Convex Session State & Event Log
   - [x] Define tables: `sessions`, `interactions`, `events`, and `assessments` summary
   - [x] Indexes: by `userId`, `sessionId`, `groupId`, `createdAt`
   - [x] Functions: `logEvent`, `appendInteraction`, `updateSessionState`, `persistAssessmentSummary`
   - [x] Persist assessment summary via callback write path
   - [x] Unit tests for write paths and indexes
   - [x] Runtime validations (ids, kinds, categories, score range)
- [x] Core API Wiring
   - [x] Pass through `X-Tracked-Skill-Id` and hash to `trackedSkillIdHash` (SHA-256) server-side
   - [x] Wire routes to call Convex: `appendInteraction`, `logEvent`, `updateSessionState`
   - [x] Ensure finalize route uses `persistAssessmentSummary`
   - [x] Structured logs include `requestId` and `trackedSkillIdHash`

## Scope
In scope
- Auth gating, schema, object storage, transcript storage
- Convex session state and event log; assessment summary persistence
- Core API wiring for Convex integration

Out of scope
- Detailed analytics/dashboard (SPR-005)
- Provider abstraction/benchmarking (SPR-006)

## Features in this Sprint
List feature IDs from Features CSV (pipe-separate multiple)
- [ ] FEAT-014 — Auth (Clerk) Integration (backend)
- [ ] FEAT-024 — Convex Schema Setup (backend)
- [ ] FEAT-025 — Audio Object Storage (S3-Compatible) (infra)
- [ ] FEAT-007 — Session Transcript Storage (backend)
- [ ] FEAT-032 — Convex Session State & Event Log (backend)

## Acceptance Criteria
- [ ] Users can sign in and access protected areas
- [ ] Schema exists with indexes; basic CRUD validated
- [ ] Interactions stored and retrievable; audio objects persisted
- [ ] Events persisted with `requestId`, `userId`, `sessionId`, `groupId`
- [ ] Assessment summaries persisted and queriable by `sessionId` and `groupId`
- [ ] Privacy: only hashed trackedSkillId appears in logs/storage; never the raw ID

## Next Steps
- [x] Add runtime validations in Core API routes and Convex functions (ids, kinds, categories, score ranges)
- [x] Implement retrieval APIs for dashboard/summary (e.g., latest summary by sessionId)
- [x] Add unit tests for write paths and verify indexes are exercised
- [ ] Confirm Convex schema activation in environments and wire functions end-to-end

## Risks & Mitigations
- Risk: Auth misconfiguration · Mitigation: dev/prod keys, test flows, runbook
- Risk: Data model churn · Mitigation: start minimal, evolve with migrations

## Dependencies
- Depends on features/sprints: SPR-002 (assessment payload shape & rubric v1)
- External: Clerk, S3-compatible storage
- Upstream: AI API propagates `trackedSkillIdHash` for privacy-preserving observability; Convex write paths should accept/record hash when provided

## Technical Details
### Database Models
- Collections/Tables impacted: User, UserSession, Interaction
- New/changed fields: define minimal fields; add createdAt, userId indexes
- Constraints/validation: required fields; size limits
- Indexes (read/write paths): by userId, sessionId, createdAt
- Migrations: initial schema — Backfill plan: NA
- Data retention: audio objects per privacy window; transcripts retained

### Object Storage (S3-compatible)
- Definition: Any object storage that implements the Amazon S3 API (e.g., AWS S3, MinIO, Cloudflare R2, LocalStack for dev). We will use S3-compatible clients and signed URL flows, so provider choice is flexible.
- Bucket naming: One bucket per environment to keep isolation and policies simple, e.g., `coachup-audio-dev`, `coachup-audio-staging`, `coachup-audio-prod`.
- Object key convention: `u/{userId}/s/{sessionId}/{ts}/{basename}`
  - Examples: `u/clk_123/s/sess_456/1692540060000/audio.wav` or `u/clk_123/s/sess_456/1692540060000/transcript.json`
  - Rationale: predictable partitioning by user and session; easy lifecycle policies and selective deletes.
- Signed URLs: Use pre-signed PUT for upload and GET for retrieval; restrict content-type and size; set short expirations (e.g., 10 minutes).
- Security/retention: Apply least-privilege IAM; enable server-side encryption; configure lifecycle rules to expire raw audio per privacy window.

### Algorithmic Details
- Approach: none — structural sprint
- Rubric Version: NA
- Latency targets: API p95 < 500ms for storage ops

### Prompts & Rubrics
- NA

## QA & Testing
- [x] Unit tests for Convex functions (guards for kinds/score ranges and IDs in `convex/functions/*`)
- [ ] Integration tests for Core API routes (hashing + Convex persistence; latest summary retrieval)
- [x] Unit tests for Core API routes (`/api/v1/interactions`, `/api/v1/sessions/state`, finalize wiring)
- [x] Unit tests for Events API route (`GET /api/v1/events`) covering validation, limit bounds, trackedSkillId hashing, and Convex error handling
- [ ] E2E: sign-in, create session, store interaction
- [x] E2E: redirect to `/sign-in` when `CLERK_PROTECT_ALL=1` (protected flow smoke)
- [x] E2E suite green baseline: 16 passed, 2 skipped (UI) after navigation stabilization
 - [x] E2E: Skills UI page renders and loads list (mock Convex)
- [ ] Upload/download smoke tests for audio
- [ ] Contract tests for protected API routes
 - [x] E2E protected spec currently blocked by Clerk detection error: "auth() was called but Clerk can't detect usage of clerkMiddleware()". Middleware logs confirm execution (`[clerk-mw] GET /`). Added diagnostics and forced `CLERK_ENABLED=0` for E2E web server to isolate.

## Observability & SLOs
Targets (see Technical Overview §10)
- Realtime chat p95 TTFT < 1.2s; full-turn < 2.5s
- Assessment p95 completion < 8s

Checkpoints
- [ ] Dashboards include auth errors and storage metrics
- [ ] Alerts on storage failures/latency
- [ ] Structured logs include requestId, userId, and trackedSkillIdHash (when provided)

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

 - Date: 22/08/2025 — Issue: Clerk cannot detect `clerkMiddleware()` despite middleware executing — Impact: Blocks protected E2E and validation of auth gating
  - Detection: Playwright web server logs show `[clerk-mw] GET /` followed by Clerk error "auth() was called but Clerk can't detect usage of clerkMiddleware()" on Next.js 15.4.7
  - Fix: Removed stale root `ui/middleware.ts`; cleared `.next` build cache; added request-path diagnostics in `src/middleware.ts`; updated `playwright.config.ts` to enforce `CLERK_ENABLED=0` during E2E to prevent API `auth()` calls
  - Follow-up: Verify no SSR path calls `auth()` outside middleware coverage; re-check `config.matcher`; evaluate Clerk/Next.js version compat; if persists, create minimal repro
  - Deviation from plan: Clerk integration and auth gating now require additional troubleshooting and potential version updates

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [x] .env.example updated if new env vars added
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for new/changed endpoints
 - [x] Monitoring CI: added validation workflow for Prometheus alerts/config and Grafana dashboards (`.github/workflows/monitoring-validate.yml`)

## Documentation
- [x] API reference updated for endpoints touched (Core & AI)
- [x] OpenAPI spec updated and linted
 - [x] Examples added/verified (curl + TypeScript)
 - [x] Cross-links updated (PRD/Technical Overview)

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed

## Change Log
- Nineteenth of August, Two Thousand and Twenty-Five Created sprint page
- Twenty-First of August, Two Thousand and Twenty-Five Added FEAT-032 and seeded Convex session state & event log plan
- Twenty-First of August, Two Thousand and Twenty-Five Status set to in_progress; start date recorded; clarified S3-compatible storage and bucket naming; added privacy objective for trackedSkillIdHash
- Twenty-First of August, Two Thousand and Twenty-Five Implemented Convex functions (`logEvent`, `appendInteraction`, `updateSessionState`, `persistAssessmentSummary`) and updated docs:
  - Convex schema now includes `sessions`, `interactions`, `events`, and `assessments` with `trackedSkillIdHash` (hashed only) and indexes.
  - API docs updated to document `X-Tracked-Skill-Id` header (privacy-preserving hashing) and added usage examples in AI API reference.
  - Core API docs updated to include `X-Tracked-Skill-Id` in conventions and examples for `/api/v1/interactions` and `/api/v1/sessions/state`.
  - Verified Convex indexes referenced by functions exist in `convex/schema.ts`: `sessions.by_sessionId`, `interactions.by_session`, `interactions.by_session_ts`, `assessments.by_session`.
 - Twenty-First of August, Two Thousand and Twenty-Five Wired Core API routes to Convex (`/api/v1/interactions`, `/api/v1/sessions/state`) with SHA-256 hashing of `X-Tracked-Skill-Id` and structured logging of `requestId` and `trackedSkillIdHash`.
 - Twenty-First of August, Two Thousand and Twenty-Five Updated finalize route to use `assessments:persistAssessmentSummary` and added CORS for `X-Tracked-Skill-Id`.
 - Twenty-First of August, Two Thousand and Twenty-Five Added unit tests for Core API routes and extended mock Convex with `appendInteraction`, `updateSessionState`, `logEvent`, and `persistAssessmentSummary`.
 - 21/08/2025 Finalized type safety and lint compliance across Core API routes and chat page; removed all explicit `any` and unsafe casts, added typed Convex call wrappers and safe UUID helper; fixed React hooks deps; verified build and unit tests green; updated sprint doc objectives and added Next Steps.

 - 21/08/2025 Added runtime validations in Core API routes (`/api/v1/interactions`, `/api/v1/sessions/state`, `/api/assessments/convex/finalize`); all unit tests passing and ESLint clean.

 - 21/08/2025 Added unit tests for Convex function write paths and index usage (`sessions.updateSessionState`, `interactions.appendInteraction`, `events.logEvent`, `assessments.persistAssessmentSummary`, `assessments.getLatestSummaryBySession`); all tests green.
  - 21/08/2025 Implemented GET `/api/v1/events` retrieval endpoint with CORS, `X-Request-Id`, and privacy-preserving hashing of `X-Tracked-Skill-Id`; added unit tests and verified.
  
  - 21/08/2025 Added runtime validations inside Convex functions (`sessions.updateSessionState`, `interactions.appendInteraction`, `events.logEvent`, `assessments.writeAssessment`) and expanded unit tests to cover negative cases; all unit tests passing and ESLint clean.
  
  - 22/08/2025 Verified unit tests green for `/api/v1/interactions`, `/api/v1/sessions/state`, and `/api/v1/events`; aligned sprint docs with privacy terminology (Skills, Tracked Skills, Focus Insights V2). Planned next steps: Clerk auth gating for API routes and E2E sign-in flow; integration tests (hashing + Convex persistence); S3-compatible audio upload/download smoke tests.
  - 22/08/2025 Clerk App Router integration updates:
    - Wrapped app with `ClerkProvider`; added header auth UI (`SignInButton`, `SignUpButton`, `UserButton`).
    - Added custom sign-in-or-up page at `app/sign-in/[[...sign-in]]/page.tsx` using `<SignIn />`.
    - Added `src/middleware.ts` using `clerkMiddleware()` with optional global protection behind `CLERK_PROTECT_ALL=1`; kept routes public by default. Root `middleware.ts` removed to satisfy Clerk placement check.
    - Removed stale root `ui/middleware.ts`, cleared `.next`, rebuilt; added diagnostic logging in `src/middleware.ts` to confirm execution (`[clerk-mw] GET /`).
    - Updated `playwright.config.ts` to set `CLERK_ENABLED=0` for E2E web server and kept `CLERK_PROTECT_ALL` opt-in via the protected spec command.
    - API route gating helper `requireAuth` added; can be enabled via `CLERK_ENABLED=1`.
    - Updated `.env.example` with Clerk keys and sign-in URL redirects (`NEXT_PUBLIC_CLERK_SIGN_IN_URL`, fallbacks) plus flags (`CLERK_ENABLED`, `CLERK_PROTECT_ALL`).
    - E2E: Stabilized navigation by using `waitUntil: 'domcontentloaded'`; suite result: 16 passed, 2 skipped. Added protected redirect spec and npm script (`test:e2e:protected`). Protected spec currently failing with Clerk detection error; triage in progress.

 - 22/08/2025 Skills API & UI additions:
   - Core API docs updated with `GET /api/v1/skills` endpoint (query params, examples, behavior notes) in `docs/api/core/reference.md`.
   - Monitoring doc updated with Skills API metrics/logging guidance in `docs/ops/monitoring.md`.
   - Minimal Skills UI page added at `ui/src/app/skills/page.tsx` which lists active skills via `/api/v1/skills`.
   - Playwright E2E added: `ui/tests/e2e/ui.skills.page.spec.ts` to navigate to `/skills` and assert the list renders.
   - OpenAPI updated in `docs/api/core/openapi.json` with `GET /api/v1/skills` path, params, responses, and schemas.
   - Home navigation link to `/skills` added in `ui/src/app/page.tsx`.
   - Skills API route monitoring enhanced with structured logs and latency in `ui/src/app/api/v1/skills/route.ts`.
   - Infra: Added monitoring validation CI workflow for Prometheus and Grafana assets in `.github/workflows/monitoring-validate.yml`.
