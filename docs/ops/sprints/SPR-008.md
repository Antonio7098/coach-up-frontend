# Sprint SPR-008 — Decoupled Session Summary Endpoint

Short: Create a dedicated conversation summary service (decoupled from assessments) with its own storage, background cadence, and manual trigger.

## Meta
- Sprint ID: SPR-008
- Status: planned
- Start date: <YYYY-MM-DD>
- End date: <YYYY-MM-DD>
- Links: [Overview](./overview.md) · [Technical Overview](../../planning/technical-overview.md)

## Objectives (Tick when achieved)
- [x] Add POST /api/v1/session-summary (generate) — standalone, not tied to assessments
- [x] Read path (GET /api/v1/session-summary) — returns latest conversation summary from Convex
- [ ] Backend cadence: generate every N turns or S seconds (env), tracked per session

## Planned Tasks
- [x] Design payload and contracts — <owner> (0.5d)
  - Request (v1): { sessionId: string; sinceTs?: number; prevSummary?: string; messages?: Array<{ role: "user"|"assistant"; content: string }>; tokenBudget?: number }
  - Response (sync v1): { status: "completed"; summary: { sessionId: string; version: number; updatedAt: number } }
  - Notes:
    - Back-compat: also accept `recentMessages` for messages array.
    - Future async: { status: "queued"|"processing"; jobId: string } then GET returns latest when ready.
- [x] Implement server route (Node/Next API) — <owner> (1d)
  - [ ] Fetch interactions since last summary (placeholder: client-provided messages)
  - [x] Summarize(previous summary + recent messages) (stubbed)
  - [x] Persist summary to Convex (new table)
- [ ] Add backend cadence — <owner> (0.5d)
  - [ ] Env: SUMMARY_GENERATE_ASSISTANT_EVERY_N, SUMMARY_GENERATE_SECONDS, SUMMARY_LOCK_MS, SUMMARY_IDEMPOTENCY_TTL_SECONDS
  - [ ] Idempotency + per-session lock (Convex) to avoid duplicate triggers
- [x] UI minimal wiring — <owner> (0.5d)
  - [x] Button calls POST generate
  - [x] Panel displays latest summary (fresh panel)
- [x] Observability — <owner> (0.5d)
  - [x] Structured logs include requestId, sessionId; basic latency

## Scope
In scope
- Dedicated summary generation independent of assessments
- Background cadence triggering
- Manual override POST endpoint

Out of scope
- Assessment logic changes
- Complex token budgeting in v1 (basic cap only)

## Features in this Sprint
- [ ] FEAT-??? — Decoupled session summary (platform)

## Acceptance Criteria
- [ ] POST /api/v1/session-summary persists a new summary row in `session_summaries`
- [ ] GET /api/v1/session-summary returns latest from `session_summaries`
- [ ] Cadence triggers auto-generation at configured thresholds (turns/seconds)
- [ ] No assessment records are created or required for summary generation

## Risks & Mitigations
- Risk: Double-generation per turn · Mitigation: idempotency key per session window
- Risk: Large inputs · Mitigation: cap messages/time window; token budget

## Dependencies
- Convex access for summary persistence

## Technical Details
### Database Models (Convex)
- New table: `session_summaries`
  - sessionId: string (indexed)
  - version: number (monotonic per session)
  - text: string (summary body)
  - lastMessageTs: number (messages cutoff included)
  - createdAt: number; updatedAt: number
  - meta: { provider?: string; modelId?: string; tokenBudget?: number }
  - Indexes: by_session (sessionId, createdAt desc), by_createdAt
- New: `summary_state` per session for cadence/idempotency
  - sessionId: string (indexed)
  - turnsSince: number // assistant-completed turns since last summary
  - assistantMsgSince: number // assistant messages since last summary (for modulo-N trigger)
  - lastGeneratedAt: number // ms since epoch
  - lastVersion: number // last persisted summary version
  - lockUntil?: number // ms since epoch to prevent duplicate triggers
  - Index: by_session

### Algorithmic Details
- Triggering (ingest-driven):
  - After persisting an assistant message (finalized), call `functions/summaries_state:onAssistantMessage({ sessionId, lastKnownVersion })`.
  - That mutation increments counters and computes due if:
    - assistantMsgSince % SUMMARY_GENERATE_ASSISTANT_EVERY_N == 0 OR
    - now - lastGeneratedAt >= SUMMARY_GENERATE_SECONDS.
  - If due, it attempts to acquire a short lock: `lockUntil = now + SUMMARY_LOCK_MS` (compare-and-set) and returns `{ dueNow, locked, reason }`.
- Orchestration (UI API): if `locked`, fetch prev summary + recent messages, POST AI API `/api/v1/session-summary/generate` with idempotency key `summary:{sessionId}:{expectedNextVersion}`, persist to `session_summaries`, then call `functions/summaries_state:onGenerated({ sessionId, newVersion, generatedAt })` to reset counters and clear lock.
- Input to LLM: prior summary + messages since last cutoff; bounded by token/char cap.
- Targets: p95 generate < 2.5s.

### Prompts & Rubrics
- Prompt names: session_summary_v1

## QA & Testing
- [x] Unit tests for POST and GET
- [x] Contract tests: POST then GET returns new summary (AI API)
- [ ] Cadence contract tests: modulo-N trigger; time trigger; single trigger under concurrency

## Observability & SLOs
- Targets: p95 generate < 2.5s
- Dashboards: add metrics to UI /metrics
- Metrics to add (UI API): `summaries_triggered_total{reason}`, `summary_generate_latency_ms`, `summary_age_ms`, `summary_locks_total{acquired|contended}`

## Issues & Deviations

## Operational Hygiene
- [ ] .env.example updated (SUMMARY_GENERATE_ASSISTANT_EVERY_N, SUMMARY_GENERATE_SECONDS, SUMMARY_LOCK_MS, SUMMARY_IDEMPOTENCY_TTL_SECONDS)
- [x] Request ID propagated
- [ ] Rate limit + idempotency

## Documentation
- [ ] API reference updated

## Post-sprint
- [ ] KPIs reviewed
- [ ] Retrospective

## Change Log
- <YYYY-MM-DD> Created sprint page
