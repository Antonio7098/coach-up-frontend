# Sprint SPR-008 — Decoupled Session Summary Endpoint

Short: Create a dedicated summary-generation API decoupled from assessments, with background cadence and manual trigger.

## Meta
- Sprint ID: SPR-008
- Status: planned
- Start date: <YYYY-MM-DD>
- End date: <YYYY-MM-DD>
- Links: [Overview](./overview.md) · [Technical Overview](../../planning/technical-overview.md)

## Objectives (Tick when achieved)
- [ ] Add POST /api/v1/session-summary (generate)
- [ ] Read path unchanged (GET /api/v1/session-summary)
- [ ] Backend cadence: generate every N turns or S seconds (env)

## Planned Tasks
- [ ] Design payload and contracts — <owner> (0.5d)
  - [ ] Request: { sessionId, sinceTs?, prevSummary? }
  - [ ] Response: { status, summary?, jobId? }
- [ ] Implement server route (Node/Next API) — <owner> (1d)
  - [ ] Fetch interactions since last summary
  - [ ] Summarize(previous summary + recent messages)
  - [ ] Persist summary to Convex
- [ ] Add backend cadence — <owner> (0.5d)
  - [ ] Env: SUMMARY_GENERATE_TURNS, SUMMARY_GENERATE_SECONDS
  - [ ] Idempotency + rate limit per session
- [ ] UI minimal wiring — <owner> (0.5d)
  - [ ] Button calls POST generate (rename to “Generate summary”)
  - [ ] Panel reflects ready/pending and turns-until-due
- [ ] Observability — <owner> (0.5d)
  - [ ] Metrics: summaries_generated_total, latency_ms, age_ms, errors
  - [ ] Structured logs include requestId, sessionId

## Scope
In scope
- Dedicated summary generation independent of assessments
- Background cadence triggering
- Manual override POST endpoint

Out of scope
- Assessment logic changes
- Complex token budgeting in v1 (basic cap only)

## Features in this Sprint
- [ ] FEAT-??? — Decoupled session summary (platform)

## Acceptance Criteria
- [ ] POST generate returns 200/202 and persists a new summary
- [ ] GET returns the latest summary without coupling to assessments
- [ ] Cadence triggers auto-generation at configured thresholds

## Risks & Mitigations
- Risk: Double-generation per turn · Mitigation: idempotency key per session window
- Risk: Large inputs · Mitigation: cap messages/time window; token budget

## Dependencies
- Convex access for summary persistence

## Technical Details
### Database Models
- Use existing `assessments` table with kind="summary" entries
- Indexes used: by_session, by_kind, by_createdAt

### Algorithmic Details
- Prompt: minimal summarizer combining prior summary + recent messages since lastSummaryAt
- Latency target: p95 < 2.5s

### Prompts & Rubrics
- Prompt names: session_summary_v1

## QA & Testing
- [ ] Unit tests for POST and GET
- [ ] Contract tests: POST then GET returns new summary

## Observability & SLOs
- Targets: p95 generate < 2.5s
- Dashboards: add metrics to UI /metrics

## Issues & Deviations

## Operational Hygiene
- [ ] .env.example updated (SUMMARY_GENERATE_TURNS/SECONDS)
- [ ] Request ID propagated
- [ ] Rate limit + idempotency

## Documentation
- [ ] API reference updated

## Post-sprint
- [ ] KPIs reviewed
- [ ] Retrospective

## Change Log
- <YYYY-MM-DD> Created sprint page
