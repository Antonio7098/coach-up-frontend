# Sprint SPR-008 — Decoupled Session Summary Endpoint

Short: Create a dedicated conversation summary service (decoupled from assessments) with its own storage, background cadence, and manual trigger.

## Meta
- Sprint ID: SPR-008
- Status: planned
- Start date: <YYYY-MM-DD>
- End date: <YYYY-MM-DD>
- Links: [Overview](./overview.md) · [Technical Overview](../../planning/technical-overview.md)

## Objectives (Tick when achieved)
- [x] Add POST /api/v1/session-summary (generate) — standalone, not tied to assessments
- [x] Read path (GET /api/v1/session-summary) — returns latest conversation summary from Convex
- [ ] Backend cadence: generate every N turns or S seconds (env), tracked per session

## Planned Tasks
- [x] Design payload and contracts — <owner> (0.5d)
  - Request (v1): { sessionId: string; sinceTs?: number; prevSummary?: string; messages?: Array<{ role: "user"|"assistant"; content: string }>; tokenBudget?: number }
  - Response (sync v1): { status: "completed"; summary: { sessionId: string; version: number; updatedAt: number } }
  - Notes:
    - Back-compat: also accept `recentMessages` for messages array.
    - Future async: { status: "queued"|"processing"; jobId: string } then GET returns latest when ready.
- [x] Implement server route (Node/Next API) — <owner> (1d)
  - [ ] Fetch interactions since last summary (placeholder: client-provided messages)
  - [x] Summarize(previous summary + recent messages) (stubbed)
  - [x] Persist summary to Convex (new table)
- [ ] Add backend cadence — <owner> (0.5d)
  - [ ] Env: SUMMARY_GENERATE_TURNS, SUMMARY_GENERATE_SECONDS
  - [ ] Idempotency + rate limit per session
- [x] UI minimal wiring — <owner> (0.5d)
  - [x] Button calls POST generate
  - [x] Panel displays latest summary (fresh panel)
- [x] Observability — <owner> (0.5d)
  - [x] Structured logs include requestId, sessionId; basic latency

## Scope
In scope
- Dedicated summary generation independent of assessments
- Background cadence triggering
- Manual override POST endpoint

Out of scope
- Assessment logic changes
- Complex token budgeting in v1 (basic cap only)

## Features in this Sprint
- [ ] FEAT-??? — Decoupled session summary (platform)

## Acceptance Criteria
- [ ] POST /api/v1/session-summary persists a new summary row in `session_summaries`
- [ ] GET /api/v1/session-summary returns latest from `session_summaries`
- [ ] Cadence triggers auto-generation at configured thresholds (turns/seconds)
- [ ] No assessment records are created or required for summary generation

## Risks & Mitigations
- Risk: Double-generation per turn · Mitigation: idempotency key per session window
- Risk: Large inputs · Mitigation: cap messages/time window; token budget

## Dependencies
- Convex access for summary persistence

## Technical Details
### Database Models (Convex)
- New table: `session_summaries`
  - sessionId: string (indexed)
  - version: number (monotonic per session)
  - text: string (summary body)
  - lastMessageTs: number (messages cutoff included)
  - createdAt: number; updatedAt: number
  - meta: { provider?: string; modelId?: string; tokenBudget?: number }
  - Indexes: by_session (sessionId, createdAt desc), by_createdAt
- Optional: `summary_state` per session for cadence/idempotency
  - sessionId: string
  - turnsSince: number; lastGeneratedAt: number; lockUntil?: number
  - Index: by_session

### Algorithmic Details
- Input: prior summary text (if any) + messages since lastMessageTs
- Output: bounded-length summary (token/char cap)
- Latency target: p95 < 2.5s

### Prompts & Rubrics
- Prompt names: session_summary_v1

## QA & Testing
- [ ] Unit tests for POST and GET
- [ ] Contract tests: POST then GET returns new summary

## Observability & SLOs
- Targets: p95 generate < 2.5s
- Dashboards: add metrics to UI /metrics

## Issues & Deviations

## Operational Hygiene
- [ ] .env.example updated (SUMMARY_GENERATE_TURNS/SECONDS)
- [ ] Request ID propagated
- [ ] Rate limit + idempotency

## Documentation
- [ ] API reference updated

## Post-sprint
- [ ] KPIs reviewed
- [ ] Retrospective

## Change Log
- <YYYY-MM-DD> Created sprint page
