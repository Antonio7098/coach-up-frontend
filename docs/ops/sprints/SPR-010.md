# Sprint SPR-007 — Provider & Benchmarking

Introduce provider abstraction layer, feature flags for provider/model swap, and benchmarking harness (offline first). Document results and selection.

## Meta
- Sprint ID: SPR-007
- Status: planned
- Start date: <YYYY-MM-DD>
- End date: <YYYY-MM-DD>
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Provider Abstraction Layer implemented
- [ ] Feature flags for provider/model swap
- [ ] Offline benchmark run on golden dataset with rubric v1
- [ ] Initial recommendation documented (quality/latency/cost)

## Planned Tasks
- [ ] Provider Abstraction — <owner> (<estimate>)
   - [ ] Define interfaces and typed clients
   - [ ] Implement ≥2 providers for chat
- [ ] Feature Flags — <owner> (<estimate>)
   - [ ] Sticky bucketing; server/edge wiring
- [ ] Benchmarking Harness — <owner> (<estimate>)
   - [ ] Dataset loader, runner, report generator
   - [ ] Judge prompts and heuristics
- [ ] Results & Docs — <owner> (<estimate>)
   - [ ] Summarize tradeoffs; update tech overview

## Scope
In scope
- Provider layer for chat; offline benchmarks; flags for A/B

Out of scope
- Full online A/B rollout (future)
- Deep safety evaluations (future)

## Features in this Sprint
List feature IDs from Features CSV (pipe-separate multiple)
- [ ] FEAT-004 — Provider Abstraction Layer (ai)
- [ ] FEAT-029 — Benchmarking & LLM Provider Evaluation (ai)
- [ ] FEAT-021 — Feature Flags for Provider Swap (infra)
- [ ] FEAT-022 — Cost Tracking & Budget Alarms (infra)

## Acceptance Criteria
- [ ] Provider layer can switch vendors via flags without code changes
- [ ] Benchmark report produced with win-rates, latency, cost
- [ ] Docs updated with recommendation and fallback plan

## Risks & Mitigations
- Risk: Dataset quality insufficient · Mitigation: curate golden set iteratively
- Risk: Cost spikes during benchmarking · Mitigation: cap quotas; sample; off-peak runs

## Dependencies
- Depends on features/sprints: SPR-001 (chat path), SPR-005 (observability/flags)
- External: provider accounts/keys

## Technical Details
### Database Models
- Collections/Tables impacted: optional PromptRun/BenchmarkResults if persisted
- New/changed fields: provider, modelId, rubricVersion in logs/results
- Constraints/validation: NA
- Indexes (read/write paths): by createdAt, provider, modelId (if stored)
- Migrations: NA — Backfill plan: NA
- Data retention: short retention for raw results if stored

### Algorithmic Details
- Approach: vendor abstraction with typed interfaces; reproducible runs
- Rubric Version: v1
- Latency targets: maintain chat SLOs; benchmark runner time-bounded

### Prompts & Rubrics
- Judge prompts and rubric dimensions documented; link to benchmarking guide

## QA & Testing
- [ ] Unit tests for provider interface and flag wiring
- [ ] Dry-run benchmark on small subset
- [ ] Contract tests across providers
- [ ] Cost guardrail tests

## Observability & SLOs
Targets (see Technical Overview §10)
- Realtime chat p95 TTFT < 1.2s; full-turn < 2.5s
- Assessment p95 completion < 8s

Checkpoints
- [ ] Dashboards show provider metrics and flag splits
- [ ] Alerts on provider error spikes and budget thresholds
- [ ] Structured logs include provider, modelId, tokens, cost, latency

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

- Date: <YYYY-MM-DD> — Issue: <short summary> — Impact: <scope/users/services>
  - Detection: <alert/log/user report>
  - Fix: <what changed> — PR: <link> — Owner: <name>
  - Follow-up: <test/monitoring/doc action>
- Deviation from plan: <what changed and why>

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [ ] .env.example updated if new env vars added
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for new/changed endpoints

## Documentation
- [ ] API reference updated for endpoints touched (Core & AI)
- [ ] OpenAPI spec updated and linted
- [ ] Examples added/verified (curl + TypeScript)
- [ ] Cross-links updated (PRD/Technical Overview)

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed

## Change Log
- 2025-08-22 Renumbered from SPR-006 to SPR-007; dependencies updated to SPR-005 for observability/flags
