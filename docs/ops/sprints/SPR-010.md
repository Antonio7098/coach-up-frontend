# Sprint SPR-010 — Triage Agent Implementation

Implement a batch Triage Agent that runs before summarization to identify and group assessable interactions, enabling more targeted and efficient assessment processing.

## Meta
- Sprint ID: SPR-010
- Status: planned
- Start date: 2025-01-15
- End date: 2025-01-29
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Implement batch Triage Agent that identifies assessable interactions (single Q&A pairs and multi-turn sequences)
- [ ] Integrate Triage Agent with existing summary cadence system (runs every N interactions)
- [ ] Add comprehensive observability and monitoring for triage processing

## Planned Tasks
- [ ] Schema Updates — Backend Team (2 days)
   - [ ] Add assessmentType and triageProcessedAt fields to interactions table
   - [ ] Add new index for efficient assessment queries
   - [ ] Update Convex functions for triage data management
- [ ] Triage Agent Implementation — Backend Team (4 days)
   - [ ] Create TriageClient base class and Google provider implementation
   - [ ] Implement batch triage processing logic
   - [ ] Add mock implementation for testing
   - [ ] Create AI API endpoint for triage processing
- [ ] Integration with Summary Cadence — Backend Team (2 days)
   - [ ] Modify summary_state.ts to trigger triage before summarization
   - [ ] Implement Convex actions for triage processing
   - [ ] Add error handling and fallback mechanisms
- [ ] Observability UI — Frontend Team (1 day)
   - [ ] Add observability tab to debug panel in /coach-min UI
   - [ ] Display interactions with groupId and assessmentType information
   - [ ] Add refresh functionality for real-time triage data viewing
- [ ] Testing & Validation — QA Team (2 days)
   - [ ] Unit tests for triage logic
   - [ ] Integration tests for batch processing
   - [ ] End-to-end testing with mock scenarios

## Scope
In scope
- Batch triage processing every N interactions (aligned with summary cadence)
- Identification of single Q&A pairs and multi-turn sequences as assessable
- Grouping of related interactions with shared groupId
- Comprehensive logging and monitoring
- Debug UI for viewing triage results and interaction grouping

Out of scope
- Real-time per-message triage processing
- Changes to existing summarization logic
- Production UI changes for triage results (debug UI only)
- Assessment system integration (handled in future sprint)
- Performance optimization (handled in future sprint)

## Features in this Sprint
List feature IDs from Features CSV (pipe-separate multiple)
- [ ] FEAT-TRIAGE-001 — Batch Triage Agent (assessment)
- [ ] FEAT-TRIAGE-002 — Observability Debug UI (debug)

## Acceptance Criteria
- [ ] Triage Agent successfully identifies single Q&A pairs and multi-turn sequences
- [ ] All assessable interactions receive a groupId, non-assessable interactions have no groupId
- [ ] Triage processing completes within 5 seconds for batches of 20 interactions
- [ ] Comprehensive logging includes triage results and performance metrics
- [ ] Mock implementation works for testing without external API dependencies
- [ ] Real LLM integration test passes on staging (triage accuracy > 85%)
- [ ] Debug UI displays interactions with groupId and assessmentType information
- [ ] Debug UI provides real-time refresh functionality for triage data

## Risks & Mitigations
- Risk: Triage Agent API calls fail or timeout · Mitigation: Implement robust error handling and fallback to mock implementation
- Risk: Performance impact on summary cadence · Mitigation: Run triage asynchronously and monitor latency metrics
- Risk: Incorrect grouping of interactions · Mitigation: Extensive testing with various conversation patterns and edge cases
- Risk: Schema migration fails on production data · Mitigation: Test migration on staging first, implement rollback script
- Risk: Triage processing blocks summary generation · Mitigation: Implement timeout and circuit breaker patterns
- Risk: Real LLM testing exceeds API quotas/costs · Mitigation: Limit test runs, use staging environment with separate API key

## Dependencies
- Depends on features/sprints: SPR-008 (Summary State Management)
- External: Google Gemini API for triage processing

## Technical Details
### Database Models
- Collections/Tables impacted: Interactions
- New/changed fields: 
  - interactions.assessmentType: optional string (e.g., "single_qa_pair", "roleplay_scenario", "general_chatter")
  - interactions.triageProcessedAt: optional number (timestamp when triage was completed)
- Constraints/validation: assessmentType must be valid enum value
- Indexes (read/write paths): interactions: ["sessionId", "assessmentType", "ts"]
- Migrations: Schema update — Backfill plan: Set triageProcessedAt to null for existing interactions
- Data retention: Triage results retained with interaction data

### Algorithmic Details
- Approach: Batch analysis of recent interactions using LLM to identify assessable patterns
- Rubric Version: v1 (triage classification)
- Latency targets: Triage processing p95 < 5s; batch size 20 interactions

### Prompts & Rubrics
- Prompt names/links: triage_batch_classification
- Judge/rubric key points: assessment worthiness, interaction grouping, type classification

## QA & Testing
- [ ] Unit tests updated/added for triage logic
- [ ] E2E happy path green (Playwright) with triage processing
- [ ] Load/SSE smoke test passes (k6) with triage overhead
- [ ] Contract tests for triage API routes
- [ ] Test scenarios: single Q&A pairs, multi-turn roleplay, mixed conversation patterns
- [ ] Error handling tests: API failures, malformed responses, timeout scenarios
- [ ] Integration test with real LLM calls (staging environment only)
  - [ ] Validate triage accuracy on real conversation transcripts
  - [ ] Test multi-turn sequence grouping with actual LLM responses
  - [ ] Performance testing with real API latency and rate limits

## Observability & SLOs
Targets (see Technical Overview §10)
- Triage processing p95 completion < 5s

Checkpoints
- [ ] Dashboards exist/updated for triage metrics
- [ ] Alerts configured for triage failures
- [ ] Structured logs include requestId, provider, modelId, tokens, cost, latency, triage results

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [ ] .env.example updated with new triage environment variables
- [ ] Request ID propagated end-to-end for triage processing paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency, triage results
- [ ] Rate limiting and idempotency considered for triage endpoints

### Rollback Plan
- Feature flag: `AI_TRIAGE_ENABLED` can be set to `0` to disable triage processing
- Database: New fields are optional, so existing data remains unaffected
- Convex functions: Fallback to existing logic if triage functions fail
- Monitoring: Alert thresholds can be adjusted to prevent false positives during rollback

## Documentation
- [ ] API reference updated for triage endpoints (AI API)
- [ ] OpenAPI spec updated and linted
- [ ] Examples added/verified (curl + TypeScript) for triage API
- [ ] Cross-links updated (PRD/Technical Overview) with triage architecture

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed
- [ ] Docs updated (PRD/Tech Overview/Runbooks) with triage system

### Success Metrics
- Triage accuracy: % of interactions correctly identified as assessable vs non-assessable
- Processing latency: Average triage processing time for batches
- Grouping accuracy: % of correctly grouped multi-turn sequences
- Real LLM accuracy: % accuracy on staging environment with actual LLM responses
- System impact: No regression in summary generation latency
- Debug UI usage: Active monitoring and debugging of triage results
- API cost efficiency: Triage processing cost per interaction within budget

## Change Log
- 2025-01-15 Created sprint page