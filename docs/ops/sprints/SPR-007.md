# Sprint SPR-007 — Assessments V2-only Migration & Level Progression

Full cutover to Assessments v2 across frontend API and Convex. Remove v1 everywhere. Require a level (0–10) for each skill assessment item, persist per-skill rows keyed by `skillHash`, and update tracked skill levels via recent-assessment averages. Add comprehensive tests, monitoring, and operational hygiene.

## Meta
- Sprint ID: SPR-007
- Status: active
- Start date: 2025-08-27
- End date: 2025-09-03
- Links: [Overview](./overview.md) · [PRD](../../planning/prd.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Remove all v1 assessment code paths, schemas, and tests from frontend and Convex
- [ ] Finalize route accepts v2-only payload: requires level, persists per-skill, updates levels (mock path complete)
- [ ] Convex stores per-skill assessments keyed by `skillHash` with necessary indexes
- [ ] Level updates computed from recent v2 assessments with history and analytics
- [ ] Full automated test coverage: unit, integration, Playwright E2E
- [ ] Logs, metrics, dashboards, and alerts for finalize v2 and level updates
- [ ] Env hygiene and docs updated; no dangling v1 config or dead code

## Planned Tasks
- [ ] V2-only API finalize route — <owner> (1.5d)
  - [x] Replace v1 schema with v2-only validation in `ui/src/app/api/assessments/convex/finalize/route.ts`
  - [x] Validate shared secret header and `rubricVersion === "v2"`
  - [x] Require `summary.skillAssessments[].level` (0–10), `skillHash`, and arrays `metCriteria/unmetCriteria/feedback`
  - [x] Resolve `userId` via `convex/functions/sessions:getBySessionId` (by `sessionId`)
  - [x] For each skill item: call Convex to write per-skill row and trigger level update (mock path done; real path returns 501 until v2 funcs exist)
  - [ ] Idempotency: dedupe by `(sessionId, groupId)` to avoid duplicate writes
- [ ] Convex schema updates (v2) — <owner> (1d)
  - [ ] Update `convex/schema.ts`:
    - [ ] `assessments`: add `skillHash` (string), `kind: "skill_assessment" | "summary"`, `level` (0–10 for per-skill rows), `rubricVersion: "v2"`, `summary` to hold v2 meta when `kind="summary"`
    - [ ] Indexes: `assessments.by_user_skillHash (userId, skillHash, createdAt)`, `assessments.by_session (sessionId)`, `assessments.by_group (groupId)`
    - [ ] New table `skill_level_history` with `userId, skillId, fromLevel, toLevel, reason, avgSource, sessionId, groupId, createdAt` (+ indexes by `userId`, `skillId`, `createdAt`)
  - [ ] Migration/backfill plan documented; archive v1 docs with tag `archivedV1: true` (no behavior dependent on v1)
- [ ] Convex functions (v2-only) — <owner> (1.5d)
  - [ ] Remove/replace v1 functions in:
    - [ ] `convex/assessments.ts` (v1-only helpers)
    - [ ] `convex/functions/assessments.ts` (v1 stubs)
  - [ ] Add `assessments:recordSkillAssessmentV2` (mutation)
    - [ ] Args: `userId, sessionId, groupId, skillHash, level (0–10), rubricVersion="v2", feedback, metCriteria, unmetCriteria`
    - [ ] Writes per-skill row with `kind="skill_assessment"`
  - [ ] Add `skills:resolveSkillIdFromHash` (query)
    - [ ] Deterministically map `skillHash` -> `skillId` by hashing `skills.id` with `SKILL_HASH_SALT`
  - [ ] Add `skills:updateLevelFromRecentAssessments` (mutation)
    - [ ] Query last `N = SKILL_LEVEL_AVERAGE_COUNT` assessments for `(userId, skillHash)`
    - [ ] Average `level` (0–10). If `avg >= currentLevel + THRESH`, increment level (max 10)
    - [ ] Write `skill_level_history` and emit analytics event
- [ ] Finalize v2 tests (frontend) — <owner> (1.5d)
  - [ ] Update `ui/tests/unit/api.assessments.convex.finalize.spec.ts` to v2 shape and behavior
  - [ ] Add integration tests to verify Convex writes and level updates (mock Convex client)
  - [ ] Add Playwright E2E to simulate a finalize v2 POST and validate tracked skill level increments, history row present
- [ ] Mock Convex + Test Harness — <owner> (1d)
  - [x] Extend `ui/src/app/api/lib/mockConvex.ts` with new mutations/queries
  - [x] Add fixtures for skills and sessions to cover user resolution and level updates (seed helpers present)
- [ ] Monitoring & Observability — <owner> (1d)
  - [ ] Structured logs across finalize path: `requestId, sessionId, groupId, userId, provider, modelId, skillsCount, latency`
  - [ ] Metrics (Prometheus): `ASSESS_FINALIZE_V2_SECONDS`, `ASSESS_PER_SKILL_WRITE_SECONDS`, `ASSESS_LEVEL_UPDATE_SECONDS`, `ASSESS_V2_PAYLOAD_ERRORS_TOTAL`, `ASSESS_LEVEL_UP_EVENTS_TOTAL`
  - [ ] Dashboards: finalize latency p50/p95, error rates, level-up rate per day
  - [ ] Alerts: high error rate (>2% 5m), latency p95 regression (+30%), level-up anomalies
- [ ] Env & Config Hygiene — <owner> (0.5d)
  - [ ] `.env.example` and runtime:
    - [ ] `SKILL_HASH_SALT`
    - [ ] `SKILL_LEVEL_AVERAGE_COUNT` (default 5)
    - [ ] `SKILL_LEVEL_INCREMENT_THRESHOLD` (default 1.0 level)
    - [ ] Ensure `PERSIST_ASSESSMENTS_URL` and `PERSIST_ASSESSMENTS_SECRET` documented for backend->frontend call
  - [ ] Remove any v1-specific envs and docs
- [ ] Documentation — <owner> (0.5d)
  - [ ] Update API docs for `POST /api/assessments/convex/finalize` v2 request/response
  - [ ] Update Technical Overview with v2-only flow, schema, and level update algorithm
  - [ ] Add migration notes (v1 archived, not processed)
- [ ] Cleanup & Removal of v1 — <owner> (0.5d)
  - [ ] Delete or archive v1-only code paths and tests
  - [ ] Ensure imports/exports have no v1 leakage

## Scope
In scope
- Full v2-only finalize flow in `ui/src/app/api/assessments/convex/finalize/route.ts`
- Convex schema and functions for v2 per-skill storage and level updates
- Tests (unit/integration/E2E), metrics, dashboards, alerts, and env hygiene
- Idempotency and concurrency safety for finalize calls

Out of scope
- Multi-turn interaction boundary detection (LLM/heuristics) behavior changes (kept as-is)
- Audio/STT/TTS pipeline (separate sprint)
- Increasing tracked skills to 3 (not part of this sprint; current code caps at 2 — reconcile later)

## Features in this Sprint
- [ ] FEAT-019 — V2-only assessment finalize + per-skill persistence (AI)
- [ ] FEAT-020 — Skill level updates from recent v2 assessments (AI/Convex)
- [ ] FEAT-021 — Observability for v2 finalize and level progress (Ops)

## Acceptance Criteria
- [ ] Finalize route rejects v1 payloads; accepts only v2 with `summary.skillAssessments[]`
- [ ] Each item must include `skillHash` and `level` (0–10). Missing/invalid level = 400
- [ ] Per-skill rows written in Convex with indexes enabling “last N by user+skillHash”
- [ ] Level update increments when average of last N levels ≥ `currentLevel + THRESH`
- [ ] A history row is recorded on every level change
- [ ] Analytics event emitted on level change with context (sessionId, groupId, avg, N)
- [ ] Idempotent finalize: processing the same `(sessionId, groupId)` twice does not duplicate rows or double-increment levels
- [ ] All tests (unit/integration/E2E) pass in CI; dashboards/alerts wired

## Risks & Mitigations
- Risk: Hidden v1 references causing runtime errors · Mitigation: repo-wide search and delete; CI checks for forbidden imports/schemas
- Risk: `skillHash` resolution drift (salt mismatch) · Mitigation: single-source env `SKILL_HASH_SALT` used in both finalize and Convex; test coverage
- Risk: Duplicate finalize events · Mitigation: idempotency guard keyed by `(sessionId, groupId)`
- Risk: Level oscillation due to noisy averages · Mitigation: choose N and THRESH; clamp to +1 per finalize; add cool-down if needed
- Risk: Index gaps impacting latency · Mitigation: add/read-path indexes; load tests on Convex queries

## Dependencies
- Backend `coach-up-ai-api` posts v2 payload (see `coach-up-ai-api/tests/test_persist_v2.py`) to `PERSIST_ASSESSMENTS_URL`
- Convex session resolution: `convex/functions/sessions:getBySessionId`
- Seeded skills catalog and `SKILL_HASH_SALT` for hash->id resolution

## Technical Details
### Database Models
- Collections/Tables impacted: `assessments`, `tracked_skills`, `skills`, `skill_level_history`, `events`
- New/changed fields:
  - `assessments.skillHash: string (required for kind="skill_assessment")`
  - `assessments.kind: "skill_assessment" | "summary"`
  - `assessments.level: number (0..10) for per-skill rows`
  - `assessments.summary: v2 summary meta when kind="summary" (e.g., provider, skillsCount)`
- Constraints/validation:
  - `level` required and 0..10 inclusive
  - `rubricVersion` must be `"v2"`
- Indexes:
  - `assessments.by_user_skillHash (userId, skillHash, createdAt)`
  - `assessments.by_session (sessionId)`
  - `assessments.by_group (groupId)`
  - `skill_level_history.by_user`, `.by_skillId`, `.by_createdAt`
- Migrations:
  - Add fields/indexes above; mark existing v1 docs with `archivedV1: true`
  - Backfill plan: none required for v2 flow; v1 not read by new code
- Data retention:
  - Per-skill assessments: 180 days
  - Level history and events: 365 days

### Algorithmic Details
- Approach: Rolling average over last `N=SKILL_LEVEL_AVERAGE_COUNT` of `level` (0–10)
- Level increment rule: if `avg >= currentLevel + SKILL_LEVEL_INCREMENT_THRESHOLD`, set `currentLevel = min(10, currentLevel + 1)`
- Rubric Version: v2
- Latency targets (backend finalize path): per-skill write p95 < 150ms; finalize end-to-end p95 < 500ms

### Prompts & Rubrics
- Rubric v2 skill assessments are authoritative; no v1 categories used
- Each skill assessment must supply `level`, `metCriteria`, `unmetCriteria`, `feedback`

## QA & Testing
- [ ] Unit tests
  - [ ] Finalize route v2 validation (required fields; rejects v1)
  - [ ] `skillHash` resolution and secret header handling
  - [ ] Convex mutations: `recordSkillAssessmentV2`, `updateLevelFromRecentAssessments`, `resolveSkillIdFromHash`
- [ ] Integration tests
  - [ ] Finalize route → Convex write → level update path with real mock Convex
  - [ ] Idempotency test (double POST same `(sessionId, groupId)`)
  - [ ] Index-backed query correctness and performance sanity
- [ ] Playwright E2E
  - [ ] Simulate v2 finalize POST and verify:
    - [ ] per-skill rows exist for all `skillAssessments`
    - [ ] tracked skill level incremented if threshold met
    - [ ] `skill_level_history` entry written
- [ ] Load/SSE smoke (k6)
  - [ ] 100 finalize req/min sustained, p95 < SLO, <2% errors
- [ ] Contract tests
  - [ ] JSON schema of v2 finalize payload
  - [ ] Secret header requirement enforced (401/403 on missing/invalid)

## Observability & SLOs
Targets
- Finalize v2 p95 latency < 500ms; per-skill write p95 < 150ms
- Level update mutation p95 < 200ms
- Error rate < 1% 5m

Checkpoints
- [ ] Dashboards updated: finalize v2 latency, errors, level-up rate
- [ ] Alerts: latency regression and error rate thresholds
- [ ] Logs include: requestId, route, userId, provider, modelId, skillsCount, latency

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

- Date: 2025-08-27 — Issue: Initial v1/v2 mismatch — Impact: finalize rejects backend v2 — Fix: v2-only finalize implemented — Follow-up: delete v1 code

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [ ] `.env.example` updated if new env vars added
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for new/changed endpoints

## Documentation
- [ ] API reference updated for endpoints touched (Core & AI)
- [ ] OpenAPI spec updated and linted
- [ ] Examples added/verified (curl + TypeScript)
- [ ] Cross-links updated (PRD/Technical Overview)

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed
- [ ] Docs updated (PRD/Tech Overview/Runbooks)

## Change Log
- 2025-08-27 Created sprint page
- 2025-08-27 Implemented v2-only finalize route with strict payload validation and mock per-skill persistence + level updates; added mock Convex v2 helpers