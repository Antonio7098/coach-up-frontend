# Sprint SPR-011 — User Memory System (Semantic + Episodic)

Design and implement a Convex-first User Memory System powering personalization and assessment context: semantic facts/preferences/goals, episodic conversation summaries, and daily progress rollups with privacy-aware retention.

## Meta
- Sprint ID: SPR-011
- Status: planned
- Start date: 28/08/2025
- End date: 
- Links: [Overview](./overview.md) · [PRD](../../planning/prd2.md) · [Technical Overview](../../planning/technical-overview.md) · [Monitoring](../../ops/monitoring.md) · [Benchmarking](../../ops/benchmarking.md) · [Features CSV](../features.csv)

## Objectives (Tick when achieved)
- [ ] Define and land Convex schema for semantic facts, episodic summaries, daily progress, gamification, and privacy consents
- [ ] Implement minimal queries/mutations to read/write memory and fetch chat context under token budget
- [ ] Integrate backend AI API to persist episodic summaries and rollups on assessment completion
- [ ] Respect privacy/retention (TTL sweeps, delete-by-user) and document behavior

## Planned Tasks
- [ ] Convex schema + indexes — <owner> (1d)
   - [ ] Add collections: users_profile, users_privacy_consents, users_preferences, users_goals, users_tracked_skills, users_memory_facts, users_memory_episodes, users_progress_daily, users_gamification
   - [ ] Create secondary indexes (userId, compound for progress) and TTL on expiresAtMs
   - [ ] Update `convex/schema.ts` and run local typegen
- [ ] Convex functions (queries/mutations) — <owner> (2d)
   - [ ] mem.getContextForChat(userId, sessionId?) with token budget
   - [ ] mem.upsertPreference, mem.addGoal/updateGoal
   - [ ] mem.ingestEpisodeSummary, progress.upsertDaily, gamification.update
- [ ] Backend AI API integration — <owner> (2d)
   - [ ] On assessment finalize, POST to Convex mem.ingestEpisodeSummary and progress.upsertDaily
   - [ ] Secure Convex calls (reuse `CONVEX_URL`, timeouts) and log ctx_source
   - [ ] Unit tests for integration paths (mock Convex)
- [ ] Privacy & retention — <owner> (1d)
   - [ ] TTL purge via Convex cron on users_memory_episodes/users_memory_facts
   - [ ] Delete-by-user function covering all collections
   - [ ] Document settings and defaults
- [ ] UI wiring — <owner> (1d)
   - [ ] Use getContextForChat in chat SSE open when CLASSIFIER_CONTEXT_LIMIT set
   - [ ] Preferences screen (MVP fields: tone, verbosity, correctionStyle, TTS voice)

## Scope
In scope
- Convex data model and core CRUD for memory
- Backend write paths from assessments to episodic/progress
- Privacy/retention enforcement and delete-by-user
- Minimal UI hooks to fetch context and edit preferences

Out of scope
- Vector embeddings/ANN search (future V2)
- Advanced audio-derived features (prosody-specific facts) — placeholder tags only
- Cross-device offline sync

## Features in this Sprint
List feature IDs from Features CSV (pipe-separate multiple)
- [ ] FEAT-MEM-001 — User Memory System (core)
- [ ] FEAT-CHAT-CTX — Chat context from memory (classifier)

## Acceptance Criteria
- [ ] Convex schema compiled; typegen succeeds; migrations applied locally
- [ ] Backend assessments generate episodic summaries and daily rollups visible via queries
- [ ] getContextForChat returns curated facts + N recent episodes within CLASSIFIER_CONTEXT_LIMIT
- [ ] Privacy: TTL purges expired docs; delete-by-user removes all memory entries
- [ ] Unit tests cover Convex functions and backend integration (green)

## Risks & Mitigations
- Risk: Token bloat in chat context · Mitigation: strict token budgeting + ranking by weight/recency
- Risk: Privacy non-compliance · Mitigation: consents table, TTL, delete-by-user, docs
- Risk: Backend/Convex coupling and timeouts · Mitigation: timeouts + retries; graceful fallback to client history

## Dependencies
- Depends on features/sprints: SPR-002/SPR-006 (backend context builder, transcript persistence)
- External: Convex dev/prod environment; Clerk userId availability; env `CLASSIFIER_CONTEXT_LIMIT`

## Technical Details
### Database Models
- Collections/Tables impacted:
  - `users_profile`, `users_privacy_consents`, `users_preferences`, `users_goals`, `users_tracked_skills`
  - `users_memory_facts`, `users_memory_episodes`, `users_progress_daily`, `users_gamification`
- New/changed fields (key ones):
  - users_memory_facts: { factId: string, kind: "preference|bio|constraint|achievement|skill_hint", text: string, tags: string[], skillId?: string, weight: number, decayMs: number, createdAtMs: number, lastReinforcedAtMs: number, expiresAtMs?: number, source: string }
  - users_memory_episodes: { episodeId: string, sessionId?: string, groupId?: string, summary: string, highlights: {type: string, text: string, skillId?: string, scoreDelta?: number}[], startIdx?: number, endIdx?: number, createdAtMs: number, expiresAtMs?: number }
  - users_progress_daily: { dateYYYYMMDD: string, skillId: string, samples: number, avgLevel: number, xpEarned: number, medals: string[], errors: string[], tokensIn: number, tokensOut: number, costUsd: number, latencyMsTotal: number, updatedAtMs: number }
- Constraints/validation:
  - `userId` required on all; `order` in tracked skills 1..3; `avgLevel` 1..10; non-negative counters
- Indexes (read/write paths):
  - All tables index by `userId`
  - `users_progress_daily` composite (userId, dateYYYYMMDD, skillId)
  - `users_memory_facts` (userId, kind), (userId, skillId), TTL on `expiresAtMs`
  - `users_memory_episodes` (userId, createdAtMs desc), TTL on `expiresAtMs`
- Migrations: NA (new collections)
- Data retention: Summaries/Facts per `retentionDays`; raw transcripts governed elsewhere

### Algorithmic Details
- Approach: Rank memories by effective score = f(weight, recency) and tags/skill match; budget tokens via `CLASSIFIER_CONTEXT_LIMIT`
- Rubric Version: v2-only assessments feed rollups
- Latency targets: TTFT < 1.2s; full-turn < 2.5s; assessment p95 < 8s

### Prompts & Rubrics
- Prompt usage: prepend curated facts + recent episodic summaries; annotate `ctx_source`
- Judge/rubric key points: clarity, persuasion, disfluency reduction, minimality, supportive tone

## QA & Testing
- [ ] Unit tests updated/added (Convex functions)
- [ ] E2E happy path green (Playwright) — chat with context on
- [ ] Load/SSE smoke test passes (k6) — unchanged budgets
- [ ] Contract tests for backend→Convex calls (mock server)

## Observability & SLOs
Targets (see Technical Overview §10)
- Realtime chat p95 TTFT < 1.2s; full-turn < 2.5s
- Assessment p95 completion < 8s

Checkpoints
- [ ] Dashboards updated: memory write rates, TTL purges, context token budget utilization
- [ ] Alerts configured: Convex error rate for mem.* and progress.* functions; context builder budget overruns
- [ ] Structured logs include requestId, userId, provider, modelId, tokens, cost, latency, ctx_source

## Issues & Deviations
Use this section to log issues encountered during the sprint, how they were resolved, and any deviations from the plan.

- Date:  — Issue:  — Impact: 
  - Detection: 
  - Fix:  — PR:  — Owner: 
  - Follow-up: 
- Deviation from plan: 

## Operational Hygiene
- [ ] CI checks green (API Docs workflow, tests/linting)
- [ ] Branch protection respected (PR + review)
- [ ] Pre-commit hooks executed (lint/format/type checks)
- [ ] .env.example updated if new env vars added
- [ ] Request ID propagated end-to-end for changed paths
- [ ] Logs include: requestId, route, userId (if available), provider, modelId, tokens, cost, latency
- [ ] Rate limiting and idempotency considered for new/changed endpoints

## Documentation
- [ ] API reference updated for endpoints touched (Core & AI)
- [ ] OpenAPI spec updated and linted
- [ ] Examples added/verified (curl + TypeScript)
- [ ] Cross-links updated (PRD/Technical Overview)

## Post-sprint
- [ ] KPIs reviewed; compare to targets
- [ ] Retrospective completed; action items filed
- [ ] Docs updated (PRD/Tech Overview/Runbooks)

## Change Log
- 28/08/2025 Created sprint page
